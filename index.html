<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDEA ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; overflow-x: hidden; }
        .sidebar-bg { background-color: #2d333b; }
        .active-item { background-color: #243b32; border-left: 4px solid #4ade80; color: #4ade80; }
        .menu-item:hover:not(.active-item) { background-color: #3d444d; }
        table th { padding: 15px; white-space: nowrap; font-size: 13px; font-weight: 800; color: #6b7280; background-color: #f9fafb; border-bottom: 2px solid #edf2f7; }
        table td { padding: 12px 8px; font-size: 14px; border-bottom: 1px solid #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s forwards; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        .drawer-root { position: fixed; inset: 0; z-index: 9999; pointer-events: none; visibility: hidden; }
        .drawer-root.is-open { pointer-events: auto; visibility: visible; }
        .drawer-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .drawer-root.is-open .drawer-overlay { opacity: 1; }
        .drawer-container { position: absolute; right: 0; top: 0; bottom: 0; width: 550px; max-width: 95vw; background: white; box-shadow: -10px 0 50px rgba(0,0,0,0.2); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .drawer-root.is-open .drawer-container { transform: translateX(0); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, Fragment, useMemo } = window.React;
        const LIFF_ID = "2005868456-cfANNVou"; 
        const API_URL = "https://tdea.fangwl591021.workers.dev/"; 
        const AuthContext = createContext(null);

        // Icons
        const IconBase = ({children}) => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{display:'inline-block', verticalAlign:'middle'}}>{children}</svg>;
        const BarChart2 = () => <IconBase><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const Users = () => <IconBase><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></IconBase>;
        const ActivityIcon = () => <IconBase><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const ChevronDown = () => <IconBase><polyline points="6 9 12 15 18 9"/></IconBase>;
        const IconPlus = () => <IconBase><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>;
        const Trash2 = () => <IconBase><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;

        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(`${API_URL}?t=${new Date().getTime()}`, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data }) 
                });
                return await response.json();
            } catch (err) { return { success: false, message: "é€£ç·šå¤±æ•—" }; }
        }

        const AuthProvider = ({ children }) => {
            const [authState, setAuthState] = useState({ status: "LOADING", user: null, role: null });
            useEffect(() => {
                const init = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (!liff.isLoggedIn()) { liff.login(); return; }
                        const p = await liff.getProfile();
                        const res = await callAPI('check', { userId: p.userId });
                        if (res.status === 'admin' || res.status === 'member') setAuthState({ status: "AUTHORIZED", user: p, role: res.status });
                        else window.location.replace("login.html");
                    } catch (err) { setAuthState({ status: "ERROR" }); }
                };
                init();
            }, []);
            if (authState.status === "LOADING") return <div className="h-screen flex items-center justify-center italic text-gray-400 font-bold uppercase">Syncing...</div>;
            return <AuthContext.Provider value={authState}>{children}</AuthContext.Provider>;
        };

        const EditDrawer = ({ isOpen, onClose, item, sheetName, onSaved, cols }) => {
            const [formData, setFormData] = useState({});
            const [isSaving, setIsSaving] = useState(false);
            const isNew = !item; // åˆ¤æ–·æ˜¯å¦ç‚ºæ–°å¢æ¨¡å¼

            useEffect(() => { setFormData(item || {}); }, [item]);
            
            // ğŸŒŸ éš±è—ã€Œç¶­è­·ã€èˆ‡ã€Œåºè™Ÿã€(è‡ªå‹•ç”¢ç”Ÿ)
            const fields = cols.map(c => c.l).filter(l => l !== "ç¶­è­·" && l !== "åºè™Ÿ");

            const handleSave = async () => { 
                setIsSaving(true); 
                // å€åˆ† æ–°å¢/ä¿®æ”¹ æŒ‡ä»¤
                const action = isNew ? 'addMember' : 'updateMemberData';
                const res = await callAPI(action, { sheetName, row: formData._row, data: formData }); 
                setIsSaving(false); 
                if(res.success) { onSaved(); onClose(); } else { alert("å¤±æ•—ï¼š" + res.message); }
            };

            return (
                <div className={`drawer-root ${isOpen ? 'is-open' : ''}`}>
                    <div className="drawer-overlay" onClick={onClose}></div>
                    <div className="drawer-container p-8">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 className="text-2xl font-black text-gray-800">{isNew ? "âœ¨ æ–°å¢æœƒå“¡" : "âœï¸ ç·¨è¼¯è³‡æ–™"}</h3>
                            <button onClick={onClose} className="text-gray-400 text-3xl font-bold hover:text-red-500">&times;</button>
                        </div>
                        <div className="flex gap-4 mb-8 pb-6 border-b">
                            <button onClick={onClose} className="flex-1 py-4 border-2 rounded-2xl font-bold text-gray-400">å–æ¶ˆ</button>
                            <button onClick={handleSave} disabled={isSaving} className="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl transition active:scale-95">
                                {isSaving ? "è™•ç†ä¸­..." : (isNew ? "ç¢ºèªæ–°å¢" : "ç¢ºèªä¿®æ”¹")}
                            </button>
                        </div>
                        <div className="space-y-4 overflow-auto flex-1 no-scrollbar pr-2">
                            {fields.map(f => (
                                <div key={f}>
                                    <label className="text-xs font-bold text-gray-400 block mb-1 uppercase">{f}</label>
                                    {f.includes("å‚™è¨»") ? <textarea className="w-full border-2 p-3 rounded-xl h-24 font-bold" value={formData[f]||""} onChange={e=>setFormData({...formData,[f]:e.target.value})}/> :
                                     f.includes("è³‡æ ¼") ? <select className="w-full border-2 p-3 rounded-xl font-bold" value={formData[f]||""} onChange={e=>setFormData({...formData, [f]:e.target.value})}><option value="">è«‹é¸æ“‡</option><option value="Y">Y</option><option value="N">N</option></select> :
                                     <input className="w-full border-2 p-3 rounded-xl font-bold" value={formData[f]||""} onChange={e=>setFormData({...formData,[f]:e.target.value})}/>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const MemberTable = ({ title, sheetName }) => {
            const [data, setData] = useState([]), [loading, setLoading] = useState(true), [search, setSearch] = useState(""), [editing, setEditing] = useState(null), [isAdding, setIsAdding] = useState(false);
            const fetchData = () => { setLoading(true); callAPI('getMemberData', { sheetName }).then(res => { setData(res.data || []); setLoading(false); }); };
            useEffect(() => fetchData(), [sheetName]);
            const filtered = data.filter(d => Object.values(d).some(v => String(v).includes(search)));
            
            // ğŸŒŸ ä¿®æ­£å¾Œçš„æ¬„ä½å®šç¾© (å®Œå…¨ç¬¦åˆæ‚¨çš„éœ€æ±‚)
            const cols = useMemo(() => {
                const stats = [{k:["æ´»å‹•å ±åæ¬¡æ•¸","å ±å"],l:"æ´»å‹•å ±åæ¬¡æ•¸",h:true},{k:["è¬›åº§é¡æ¬¡æ•¸","è¬›åº§"],l:"è¬›åº§é¡æ¬¡æ•¸"},{k:["æ•™å­¸é¡æ¬¡æ•¸","æ•™å­¸"],l:"æ•™å­¸é¡æ¬¡æ•¸"},{k:["è¯èª¼é¡æ¬¡æ•¸","è¯èª¼"],l:"è¯èª¼é¡æ¬¡æ•¸"},{k:["å‚™è¨»"],l:"å‚™è¨»",mw:"250px"}];
                if (sheetName.includes("æœ¬æ¥­")) return [{k:["åºè™Ÿ"],l:"åºè™Ÿ"},{k:["æœƒå“¡ç·¨è™Ÿ"],l:"æœƒå“¡ç·¨è™Ÿ"},{k:["èº«åˆ†"],l:"èº«åˆ†"},{k:["å§“å"],l:"å§“å"},{k:["æ€§åˆ¥"],l:"æ€§åˆ¥"},{k:["æœƒå“¡è³‡æ ¼(Y/N)","è³‡æ ¼"],l:"æœƒå“¡è³‡æ ¼(Y/N)"},...stats];
                if (sheetName.includes("å» å•†")) return [{k:["åºè™Ÿ"],l:"åºè™Ÿ"},{k:["æœƒå“¡ç·¨è™Ÿ"],l:"æœƒå“¡ç·¨è™Ÿ"},{k:["å…¬å¸åç¨±"],l:"å…¬å¸åç¨±"},{k:["å…¬å¸çµ±ç·¨"],l:"å…¬å¸çµ±ç·¨"},{k:["å…¬å¸è² è²¬äºº"],l:"å…¬å¸è² è²¬äºº"},{k:["è¯çµ¡çª—å£"],l:"è¯çµ¡çª—å£"},{k:["æœƒå“¡è³‡æ ¼(Y/N)","è³‡æ ¼"],l:"æœƒå“¡è³‡æ ¼(Y/N)"},...stats];
                return [{k:["åºè™Ÿ"],l:"åºè™Ÿ"},{k:["å§“å"],l:"å§“å"},{k:["è¡Œå‹•é›»è©±"],l:"è¡Œå‹•é›»è©±"},{k:["æœƒå“¡è³‡æ ¼(Y/N)","è³‡æ ¼"],l:"æœƒå“¡è³‡æ ¼(Y/N)"},...stats];
            }, [sheetName]);
            
            const gv = (item, keys) => { const k = Object.keys(item).find(key => keys.some(s => key.includes(s))); return k ? item[k] : ""; };
            
            const handleDelete = async (row) => {
                if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
                const res = await callAPI('deleteMember', { sheetName, row });
                if(res.success) { fetchData(); } else { alert("åˆªé™¤å¤±æ•—"); }
            };

            return (
                <div className="p-8 fade-in">
                    <EditDrawer isOpen={!!editing || isAdding} item={editing} sheetName={sheetName} onClose={()=>{setEditing(null);setIsAdding(false);}} onSaved={fetchData} cols={cols} />
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-3xl font-black text-gray-800 tracking-tighter">{title}</h2>
                        <div className="flex gap-3">
                            <input placeholder="æœå°‹..." className="border-2 p-3 rounded-2xl w-80 shadow-sm outline-none" value={search} onChange={e=>setSearch(e.target.value)}/>
                            <button onClick={()=>setIsAdding(true)} className="bg-green-500 text-white px-6 py-3 rounded-2xl font-bold shadow-lg flex items-center gap-2 hover:bg-green-600 transition"><IconPlus/> æ–°å¢æœƒå“¡</button>
                            <button onClick={fetchData} className="bg-white border-2 p-3 rounded-2xl font-bold shadow-sm hover:bg-gray-50 transition">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div className="bg-white rounded-[2.5rem] shadow-xl overflow-x-auto border-4 border-white">
                        <table className="w-full text-sm text-center">
                            <thead className="bg-gray-50 border-b"><tr>{cols.map((c,i)=><th key={i} className="whitespace-nowrap">{c.l}</th>)}<th>ç¶­è­·</th></tr></thead>
                            <tbody>{loading ? <tr><td colSpan={20} className="p-32 italic font-black text-gray-300 uppercase animate-pulse">Syncing...</td></tr> : filtered.map((item, idx) => (
                                <tr key={idx} className="border-b hover:bg-gray-50 transition-all">
                                    {cols.map((c,ci)=><td key={ci} className={`${c.h ? "font-black text-blue-500 text-base" : ""} ${c.l === "å‚™è¨»" ? "text-left text-xs truncate max-w-[250px]" : "whitespace-nowrap"}`}>{gv(item, c.k)}</td>)}
                                    <td className="p-4 flex gap-2 justify-center">
                                        <button onClick={()=>setEditing(item)} className="bg-blue-50 text-blue-600 border-2 border-blue-100 px-4 py-1.5 rounded-xl font-bold text-xs hover:bg-blue-600 hover:text-white transition">ç·¨è¼¯</button>
                                        <button onClick={()=>handleDelete(item._row)} className="bg-red-50 text-red-600 border-2 border-red-100 px-3 py-1.5 rounded-xl font-bold text-xs hover:bg-red-600 hover:text-white transition"><Trash2/></button>
                                    </td>
                                </tr>
                            ))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- ä»¥ä¸‹ç‚º Dashboard, ActivityConsole, MemberLobby ç­‰çµ„ä»¶ (ç¶­æŒä¸è®Š) ---
        // è«‹ç¢ºä¿ä¿ç•™ MainApp èˆ‡ App å…¥å£
        // (ç‚ºäº†å®Œæ•´æ€§ï¼Œæ‚¨å¯ä»¥æ²¿ç”¨ä¸Šä¸€ç‰ˆçš„ MainApp çµæ§‹ï¼Œåªéœ€æ›¿æ› MemberTable èˆ‡ EditDrawer å³å¯)
        // ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼Œé€™è£¡åªé¡¯ç¤ºä¿®æ”¹å¾Œçš„ MemberTable èˆ‡ EditDrawer
        // è«‹å°‡é€™äº›ä»£ç¢¼æ•´åˆé€²å®Œæ•´çš„ index.html ä¸­
        
        // ... (Dashboard, ActivityConsole, MemberLobby, MainApp, App) ...
        const Dashboard = ({ activityData }) => ( /* ... v16.5 ä»£ç¢¼ ... */ null ); // ä½”ä½ï¼Œè«‹ä½¿ç”¨å®Œæ•´ç‰ˆ
        const ActivityConsole = () => ( /* ... v16.5 ä»£ç¢¼ ... */ null ); // ä½”ä½
        const MemberLobby = () => ( /* ... v16.5 ä»£ç¢¼ ... */ null ); // ä½”ä½

        const MainApp = () => {
            const { role } = useContext(AuthContext);
            const [view, setView] = useState('dashboard'), [activityData, setActivityData] = useState([]), [expandedMenu, setExpandedMenu] = useState(false);
            const fetchActivities = () => { callAPI('getActivityList').then(res => setActivityData(res.data || [])); };
            useEffect(() => { if(role==='admin') fetchActivities(); }, [role]);

            if (role === "member") return <MemberLobby />;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* ... (å´é‚Šæ¬„èˆ‡ä¸»è¦å…§å®¹å€ï¼Œè«‹è¤‡è£½å®Œæ•´ç‰ˆ) ... */}
                    {/* é—œéµï¼šåœ¨æ¸²æŸ“ MemberTable æ™‚å‚³å…¥æ­£ç¢ºçš„ sheetName */}
                    <main className="flex-1 overflow-auto bg-[#f8fafc] no-scrollbar">
                         {/* ... */}
                         {view==='assoc' && <MemberTable title="å”æœƒæ­£å¼æœƒå“¡åå†Šç®¡ç†" sheetName="æœ¬æ¥­æœƒå“¡" />}
                         {view==='vendor' && <MemberTable title="å» å•†è´ŠåŠ©å–®ä½åå†Šç®¡ç†" sheetName="å» å•†æœƒå“¡" />}
                         {view==='guest' && <MemberTable title="ä¸€èˆ¬è¨»å†Šåå†Šè³‡æ–™ç®¡ç†" sheetName="ä¸€èˆ¬æœƒå“¡" />}
                         {/* ... */}
                    </main>
                </div>
            );
        }
        
        const App = () => ( <AuthProvider><MainApp /></AuthProvider> );
        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
