<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TDEA æ´»å‹•ç®¡ç†ç³»çµ± - æ¬Šé™é©—è­‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .fade-in { animation: fadeIn .4s ease-in-out forwards; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
    .hidden { display: none !important; }
    .btn-line { background: linear-gradient(to right, #06c755, #05b34c); }
    .btn-line:active { background: #049f43; transform: scale(0.98); }
    .input-field:focus { border-color: #06c755; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.2); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans text-gray-700">

  <!-- ğŸŸ¢ Loading / é©—è­‰ä¸­ç•«é¢ (Splash) -->
  <div id="splash" class="flex flex-col items-center justify-center w-full max-w-sm mx-auto text-center space-y-6 fade-in">
    <div class="relative w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-4">
      <i class="fa-solid fa-shield-halved text-4xl text-green-500"></i>
    </div>
    <div class="space-y-2">
      <h2 class="text-xl font-bold text-gray-800">TDEA æ´»å‹•ç®¡ç†ç³»çµ±</h2>
      <div class="flex items-center justify-center space-x-2 text-green-600 text-sm font-medium">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>æ¬Šé™é©—è­‰ä¸­...</span>
      </div>
    </div>
  </div>

  <!-- â³ å¯©æ ¸ä¸­ç•«é¢ -->
  <div id="pendingPage" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center hidden fade-in">
    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fa-solid fa-hourglass-half text-3xl text-yellow-600"></i>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">æ¬Šé™å¯©æ ¸ä¸­</h2>
    <p class="text-gray-600 mb-4">æ‚¨çš„ç”³è«‹å·²é€å‡ºï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡æ ¸å‡†é–‹é€šæ¬Šé™ã€‚</p>
    
    <div class="bg-gray-50 rounded-lg p-4 text-left text-xs text-gray-500 mb-6 border border-gray-200">
      <p class="mb-1"><strong>ç”³è«‹äººï¼š</strong> <span id="pendingName">-</span></p>
      <p class="mb-1"><strong>ç›®å‰ç‹€æ…‹ï¼š</strong> <span class="text-orange-500 font-bold">å¾…å¯©æ ¸</span></p>
      <p class="text-gray-400 mt-2 text-[10px]">ç®¡ç†å“¡å°‡ç‹€æ…‹æ›´æ”¹ç‚ºã€Œæ ¸å‡†ã€æˆ–ã€Œç®¡ç†å“¡ã€å¾Œï¼Œé»æ“Šä¸‹æ–¹é‡æ–°æ•´ç†å³å¯é€²å…¥ã€‚</p>
    </div>

    <button onclick="window.location.reload()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">
      <i class="fa-solid fa-rotate-right mr-2"></i>é‡æ–°æ•´ç†ç‹€æ…‹
    </button>
  </div>

  <!-- ğŸ“ è¨»å†Šè¡¨å–® -->
  <div id="registerForm" class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden hidden fade-in">
    <div class="bg-green-500 p-6 text-center text-white relative">
        <h1 class="text-xl font-bold tracking-wide">å¾Œå°æ¬Šé™ç”³è«‹</h1>
        <p class="text-green-100 text-sm mt-1">è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥ä¾›å¯©æ ¸</p>
        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2">
            <div class="w-16 h-16 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-md">
                <img id="userAvatar" src="https://via.placeholder.com/150" alt="Avatar" class="w-full h-full object-cover">
            </div>
        </div>
    </div>

    <div class="pt-12 pb-8 px-6 space-y-4">
      <div class="text-center mb-4">
        <p id="displayName" class="font-bold text-gray-800 text-lg">è¼‰å…¥ä¸­...</p>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">çœŸå¯¦å§“å</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-regular fa-user text-gray-400"></i>
            </div>
            <input id="name" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" 
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-phone text-gray-400"></i>
            </div>
            <input id="phone" type="tel" placeholder="0912345678" maxlength="10"
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <div class="pt-4">
        <button id="registerBtn" onclick="registerUser()" class="btn-line w-full text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-green-200 transition-all flex items-center justify-center space-x-2">
            <span id="btnText">æäº¤ç”³è«‹</span>
            <div id="btnSpinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
        </button>
      </div>
    </div>
  </div>

<script>
/* ==========================================
   âš™ï¸ ç³»çµ±è¨­å®š
   ========================================== */
const LIFF_ID  = '2005868456-cfANNVou';     
const GAS_URL  = 'https://script.google.com/macros/s/AKfycbz9upyiy4QNL9OCqanKJY2HLBQ9Od2Z_7QFbwvQ9Qf2DBJeuM6rmFDXSxSTI6ymp3lY/exec'; 
const NEXT_PAGE = 'main.html';

const $ = id => document.getElementById(id);

function showPage(pageId) {
    ['splash', 'registerForm', 'pendingPage'].forEach(id => $(id).classList.add('hidden'));
    $(pageId).classList.remove('hidden');
}

let currentUserId = null;

/* ==========================================
   ğŸš€ åˆå§‹åŒ–æµç¨‹
   ========================================== */
window.onload = async function() {
    try {
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        
        // é å¡«ä»‹é¢è³‡è¨Š
        $('displayName').textContent = profile.displayName;
        if (profile.pictureUrl) $('userAvatar').src = profile.pictureUrl;
        $('name').value = profile.displayName;

        // åŸ·è¡Œæ¬Šé™æª¢æŸ¥
        await checkPermission(currentUserId);

    } catch (err) {
        console.error('LIFF Init Error:', err);
        alert('ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤ï¼š' + err.message);
    }
};

/**
 * æ ¸å¿ƒæ¬Šé™æª¢æŸ¥å‡½å¼ (å«é˜²å¿«å–æ©Ÿåˆ¶)
 */
async function checkPermission(userId) {
    try {
        // ğŸŒŸ åŠ å…¥æ™‚é–“æˆ³è¨˜é¿å… fetch æŠ“åˆ°èˆŠçš„å¿«å–çµæœ
        const nocacheUrl = GAS_URL + '?t=' + new Date().getTime();
        
        const response = await fetch(nocacheUrl, {
            method: 'POST',
            mode: 'cors',
            body: JSON.stringify({ action: 'check', userId: userId })
        });
        const result = await response.json();

        console.log("æ¬Šé™é©—è­‰å›å‚³ï¼š", result);

        if (result.status === 'ok') {
            // âœ… é€šéï¼šè·³è½‰è‡³ç®¡ç†ä¸»é 
            window.location.replace(NEXT_PAGE);
        } 
        else if (result.status === 'pending') {
            // â³ å¾…å¯©æ ¸ï¼šé¡¯ç¤ºç­‰å¾…é é¢
            $('pendingName').textContent = result.name || "ç”³è«‹äºº";
            showPage('pendingPage');
        } 
        else {
            // ğŸ“ æ–°ä½¿ç”¨è€…ï¼šé¡¯ç¤ºè¨»å†Šè¡¨å–®
            showPage('registerForm');
        }
    } catch (err) {
        console.error('Check Failed:', err);
        // è‹¥ç™¼ç”Ÿé€£ç·šéŒ¯èª¤ï¼Œä¿å®ˆèµ·è¦‹é¡¯ç¤ºè¡¨å–®
        showPage('registerForm');
    }
}

/**
 * æäº¤è¨»å†Šç”³è«‹
 */
async function registerUser() {
    const name = $('name').value.trim();
    const phone = $('phone').value.trim();

    if (!name || !phone) { alert('è«‹å¡«å¯«å®Œæ•´å§“åèˆ‡é›»è©±'); return; }
    if (!/^09\d{8}$/.test(phone)) { alert('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼'); return; }

    const btn = $('registerBtn');
    btn.disabled = true;
    $('btnText').classList.add('hidden');
    $('btnSpinner').classList.remove('hidden');

    try {
        const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'cors',
            body: JSON.stringify({
                action: 'register',
                userId: currentUserId,
                name: name,
                phone: phone
            })
        });

        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ç”³è«‹å·²é€å‡ºï¼è«‹è¯ç¹«ç®¡ç†å“¡æ ¸å‡†æ¬Šé™ã€‚');
            $('pendingName').textContent = name;
            showPage('pendingPage');
        } else {
            alert('è¨»å†Šå¤±æ•—ï¼š' + result.message);
            resetBtn();
        }
    } catch (err) {
        alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦æ­£ç¢ºã€‚');
        resetBtn();
    }
}

function resetBtn() {
    const btn = $('registerBtn');
    btn.disabled = false;
    $('btnText').classList.remove('hidden');
    $('btnSpinner').classList.add('hidden');
}
</script>
</body>
</html>
