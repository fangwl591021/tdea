<script type="text/babel">
  /**
   * æ´»å‹•ç®¡ç†æ¨¡çµ„ v6.3.0 (é—œé–‰ä¸é‡æ•´å„ªåŒ–ç‰ˆ)
   * ä¿®æ”¹é‡é»ï¼š
   * 1. ä¿®æ­£ LotteryDrawer çš„ onClose è¡Œç‚ºï¼Œç§»é™¤å¼·åˆ¶ refreshListã€‚
   * 2. æ–°å¢ onDataChange æ©Ÿåˆ¶ï¼Œåªæœ‰åœ¨çœŸçš„æŠ½ç/æ¸…é™¤æˆåŠŸå¾Œæ‰åˆ·æ–°åˆ—è¡¨ã€‚
   */

  const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;

  const getBatchColor = (batchNum) => {
    const num = parseInt(String(batchNum).replace(/\D/g, '')) || 0;
    const colors = ['text-red-600', 'text-blue-600', 'text-green-600', 'text-purple-600', 'text-orange-600', 'text-pink-600'];
    return colors[(num - 1) % colors.length] || 'text-gray-800';
  };

  // --- æŠ½ç Drawer ---
  const LotteryDrawer = ({ isOpen, activity, onClose, onDataChange }) => {
    const [candidates, setCandidates] = React.useState([]);
    const [winners, setWinners] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    
    const [drawCount, setDrawCount] = React.useState(1);
    const [prizeName, setPrizeName] = React.useState("");
    const [onlyCheckedIn, setOnlyCheckedIn] = React.useState(true);
    const [drawing, setDrawing] = React.useState(false);

    React.useEffect(() => {
      if (isOpen && activity) {
        setLoading(true);
        if (typeof google !== 'undefined') {
          google.script.run.withSuccessHandler((res) => {
            const all = res || [];
            const w = all.filter(p => p.batch && p.batch !== "");
            w.sort((a, b) => parseInt(String(b.batch).replace(/\D/g,'')) - parseInt(String(a.batch).replace(/\D/g,'')));
            setCandidates(all);
            setWinners(w);
            setLoading(false);
          }).getLotteryParticipants(activity['æ´»å‹•è©¦ç®—è¡¨ID']);
        } else { setTimeout(() => setLoading(false), 500); }
      }
    }, [isOpen, activity]);

    const handleDraw = () => {
      if (!prizeName) { alert("è«‹è¼¸å…¥çé …åç¨±ï¼"); return; }
      if (drawCount <= 0) { alert("äººæ•¸éŒ¯èª¤"); return; }
      const pool = candidates.filter(p => {
        const isWin = p.batch && p.batch !== "";
        const isCheck = p.status !== "æœªç°½åˆ°" && p.status !== "";
        if (isWin) return false;
        if (onlyCheckedIn && !isCheck) return false;
        return true;
      });
      if (pool.length < drawCount) { alert(`åˆæ ¼äººæ•¸ä¸è¶³ (åƒ… ${pool.length} äºº)`); return; }

      setDrawing(true);
      const newWinners = [];
      const poolCopy = [...pool];
      for (let i = 0; i < drawCount; i++) {
        const idx = Math.floor(Math.random() * poolCopy.length);
        const winner = poolCopy.splice(idx, 1)[0];
        winner.prize = prizeName;
        newWinners.push({ row: winner._row, prize: prizeName });
      }

      if (typeof google !== 'undefined') {
        google.script.run.withSuccessHandler((res) => {
          setDrawing(false);
          if (res.success) {
            alert(`ğŸ‰ ç¬¬ ${res.batch} æ¢¯æ¬¡æŠ½çå®Œæˆï¼`);
            const newBatchList = newWinners.map(nw => {
                const p = candidates.find(c => c._row === nw.row);
                return { ...p, prize: nw.prize, batch: res.batch };
            });
            setWinners([...newBatchList, ...winners]);
            setCandidates(prev => prev.map(p => {
              const win = newWinners.find(w => w.row === p._row);
              return win ? { ...p, prize: win.prize, batch: res.batch } : p;
            }));
            // è§¸ç™¼å¤–éƒ¨åˆ·æ–° (åªæ›´æ–°æ•¸å­—ï¼Œä¸é‡æ•´ç•«é¢)
            if (onDataChange) onDataChange();
          } else { alert("å­˜æª”å¤±æ•—: " + res.error); }
        }).saveLotteryResults(activity['æ´»å‹•è©¦ç®—è¡¨ID'], newWinners);
      }
    };

    const handleClear = () => {
      if (!confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) return;
      google.script.run.withSuccessHandler(() => {
        setCandidates(prev => prev.map(p => ({ ...p, prize: "", batch: "" })));
        setWinners([]);
        if (onDataChange) onDataChange();
      }).clearLotteryData(activity['æ´»å‹•è©¦ç®—è¡¨ID']);
    };
    const handlePrint = () => { window.print(); };
    const handleDownloadCSV = () => {
      if (winners.length === 0) return;
      const headers = ["æ¢¯æ¬¡", "çé …", "å§“å", "é›»è©±"];
      const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + 
        winners.map(w => `ç¬¬${w.batch}æ¢¯,${w.prize},${w.name},${w.phone}`).join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csvContent);
      link.download = `ä¸­çåå–®_${activity['æ´»å‹•åç¨±']}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    const totalCount = candidates.length;
    const qualifiedCount = candidates.filter(p => !p.batch && (!onlyCheckedIn || (p.status !== "æœªç°½åˆ°" && p.status !== ""))).length;

    if (!isOpen || !activity) return null;

    return (
      <div className="fixed inset-0 z-[200] flex justify-end">
        <div className="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
        <div className="relative w-full max-w-5xl bg-gray-50 h-full shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out overflow-hidden animate-in slide-in-from-right">
          <div className="bg-[#fceda2] p-8 text-center shadow-sm relative print:shadow-none flex-shrink-0">
            <div className="absolute top-6 left-6 print:hidden">
               <button onClick={onClose} className="bg-white/90 hover:bg-white text-gray-800 px-5 py-2 rounded-xl font-bold shadow-md transition-all text-base flex items-center gap-2"><span>â†</span> è¿”å›åˆ—è¡¨</button>
            </div>
            <h1 className="text-4xl font-black text-red-600 tracking-wider mb-2 mt-2">é¦¬å¹´å¥½é‹åˆ°ã€é¦¬ä¸Šæœ‰éŒ¢</h1>
            <h2 className="text-3xl font-bold text-gray-800">å¹¸é‹æŠ½æŠ½æ¨‚</h2>
            <p className="text-gray-700 mt-3 font-bold text-xl bg-white/50 inline-block px-6 py-1 rounded-full">{activity['æ´»å‹•åç¨±']}</p>
          </div>
          <div className="p-6 bg-white shadow-sm border-b print:hidden flex-shrink-0">
            <div className="flex flex-wrap gap-6 items-end justify-center">
              <div><label className="block text-xs font-bold text-gray-500 mb-1">çé …åç¨±</label><input className="border-2 p-2 rounded-lg w-48 text-base" placeholder="è¼¸å…¥çé …" value={prizeName} onChange={e => setPrizeName(e.target.value)} /></div>
              <div><label className="block text-xs font-bold text-gray-500 mb-1">äººæ•¸</label><input type="number" className="border-2 p-2 rounded-lg w-24 text-base" value={drawCount} onChange={e => setDrawCount(e.target.value)} /></div>
              <div className="flex gap-2">
                <button onClick={handleDraw} disabled={drawing} className="bg-[#28a745] text-white px-6 py-2 rounded-lg font-bold shadow-md hover:brightness-105 disabled:opacity-50 text-base">{drawing ? "..." : "é–‹å§‹æŠ½ç"}</button>
                <button onClick={handlePrint} className="bg-[#ffc107] text-gray-900 px-4 py-2 rounded-lg font-bold shadow-md hover:brightness-105 text-base">PDF</button>
                <button onClick={handleDownloadCSV} className="bg-[#007bff] text-white px-4 py-2 rounded-lg font-bold shadow-md hover:brightness-105 text-base">CSV</button>
                <button onClick={handleClear} className="bg-[#dc3545] text-white px-4 py-2 rounded-lg font-bold shadow-md hover:brightness-105 text-base">æ¸…é™¤</button>
              </div>
            </div>
          </div>
          <div className="bg-gray-100 py-2 text-center text-base font-bold text-gray-700 border-b print:hidden flex-shrink-0">
            ç¸½åå–®ï¼š<span className="text-blue-600">{totalCount}</span> | åˆæ ¼å¯æŠ½ï¼š<span className="text-green-600">{qualifiedCount}</span>
            <label className="ml-4 cursor-pointer inline-flex items-center gap-2 bg-white px-3 py-0.5 rounded border shadow-sm"><input type="checkbox" className="w-4 h-4" checked={onlyCheckedIn} onChange={e => setOnlyCheckedIn(e.target.checked)} /> <span className="text-sm">åƒ…é™å·²ç°½åˆ°</span></label>
          </div>
          <div className="flex-1 p-6 overflow-auto print:p-0 print:overflow-visible">
            <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-lg border overflow-hidden print:shadow-none print:border-none">
              <table className="w-full text-base text-left">
                <thead className="bg-gray-100 border-b-2 border-gray-300 print:bg-gray-50"><tr><th className="p-4 font-black text-gray-700">æ¢¯æ¬¡</th><th className="p-4 font-black text-gray-700">çé …</th><th className="p-4 font-black text-gray-700">å§“å</th><th className="p-4 font-black text-gray-700">é›»è©±</th></tr></thead>
                <tbody className="divide-y divide-gray-200">
                  {winners.length === 0 ? <tr><td colSpan="4" className="p-16 text-center text-gray-400 italic text-lg">ç›®å‰å°šç„¡ä¸­çç´€éŒ„</td></tr> : winners.map((w, i) => (
                    <tr key={i} className="hover:bg-yellow-50 transition-colors">
                      <td className={`p-4 font-black ${getBatchColor(w.batch)}`}>ç¬¬ {w.batch} æ¢¯</td>
                      <td className="p-4 font-bold text-gray-900">{w.prize}</td>
                      <td className="p-4 font-bold text-gray-900">{w.name}</td>
                      <td className="p-4 text-gray-600 font-mono">{w.phone}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // ... (ReclassifyModal, CreateActivityModal, DetailsRow ä¿æŒä¸è®Š) ...
  const ReclassifyModal = ({ isOpen, onClose, target, onConfirm }) => {
    const [newType, setNewType] = React.useState('è¬›åº§é¡');
    const [loading, setLoading] = React.useState(false);
    React.useEffect(() => { if (target) setNewType(target['æ´»å‹•é¡å‹'] || 'è¬›åº§é¡'); }, [target]);
    if (!isOpen || !target) return null;
    const handleConfirm = () => {
      setLoading(true);
      if (typeof google !== 'undefined') {
        google.script.run.withSuccessHandler((res) => { setLoading(false); if(res.success){ onConfirm(); onClose(); } else { alert(res.error); } }).updateActivityType(target['æ´»å‹•åç¨±'], newType);
      }
    };
    return (
      <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6">
          <h3 className="text-xl font-bold mb-4">ğŸ·ï¸ é‡æ–°åˆ†é¡: {target['æ´»å‹•åç¨±']}</h3>
          <select className="w-full border p-3 rounded-lg mb-6 text-base" value={newType} onChange={(e) => setNewType(e.target.value)}><option>è¬›åº§é¡</option><option>æ•™å­¸é¡</option><option>è¯èª¼é¡</option><option>å…¶ä»–</option></select>
          <div className="flex gap-3"><button onClick={onClose} className="flex-1 py-2 border rounded-lg">å–æ¶ˆ</button><button onClick={handleConfirm} disabled={loading} className="flex-[2] py-2 bg-purple-600 text-white rounded-lg">{loading ? "..." : "ç¢ºèª"}</button></div>
        </div>
      </div>
    );
  };

  const CreateActivityModal = ({ isOpen, onClose, onSaved }) => {
    const [form, setForm] = React.useState({ name: '', content: '', type: 'è¬›åº§é¡', courseTime: '', deadline: '', capacity: '20', needMeal: false });
    const [loading, setLoading] = React.useState(false);
    if (!isOpen) return null;
    const handleSubmit = () => {
      if (!form.name) { alert("è«‹è¼¸å…¥æ´»å‹•åç¨±"); return; }
      setLoading(true);
      if (typeof google !== 'undefined') {
        google.script.run.withSuccessHandler((res) => { setLoading(false); if (res.success) { alert("âœ¨ æˆåŠŸï¼"); onSaved(); onClose(); setForm({ name: '', content: '', type: 'è¬›åº§é¡', courseTime: '', deadline: '', capacity: '20', needMeal: false }); } else { alert("éŒ¯èª¤: " + res.error); } }).createNewActivityWithForm(form);
      }
    };
    return (
      <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" style={{ zIndex: 9999 }}>
        <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
          <div className="px-8 py-6 border-b bg-gray-50 flex justify-between items-center"><div className="flex items-center gap-2"><span className="text-2xl">âœ¨</span><h2 className="text-2xl font-black text-black">å‰µå»ºæ–°æ´»å‹•</h2></div><button onClick={onClose} className="text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button></div>
          <div className="p-8 overflow-y-auto space-y-5">
            <div><label className="block text-sm font-bold text-black mb-1">æ´»å‹•åç¨±</label><input className="w-full border p-3 rounded-lg font-bold text-black" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div>
            <div><label className="block text-sm font-bold text-black mb-1">æ´»å‹•å…§å®¹</label><textarea className="w-full border p-3 rounded-lg h-24 text-black" value={form.content} onChange={e => setForm({...form, content: e.target.value})} /></div>
            <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-black mb-1">é¡å‹</label><select className="w-full border p-3 rounded-lg text-black bg-white" value={form.type} onChange={e => setForm({...form, type: e.target.value})}><option>è¬›åº§é¡</option><option>æ•™å­¸é¡</option><option>è¯èª¼é¡</option><option>å…¶ä»–</option></select></div><div><label className="block text-sm font-bold text-black mb-1">é™é¡</label><input type="number" className="w-full border p-3 rounded-lg text-black" value={form.capacity} onChange={e => setForm({...form, capacity: e.target.value})} /></div></div>
            <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-black mb-1">æ™‚é–“</label><input className="w-full border p-3 rounded-lg text-black" placeholder="YYYY-MM-DD" value={form.courseTime} onChange={e => setForm({...form, courseTime: e.target.value})} /></div><div><label className="block text-sm font-bold text-black mb-1">æˆªæ­¢</label><input className="w-full border p-3 rounded-lg text-black" placeholder="YYYY-MM-DD" value={form.deadline} onChange={e => setForm({...form, deadline: e.target.value})} /></div></div>
            <div className="pt-2"><label className="flex items-center gap-3 p-4 border rounded-xl bg-gray-50 cursor-pointer"><input type="checkbox" className="w-5 h-5 text-green-600 rounded" checked={form.needMeal} onChange={e => setForm({...form, needMeal: e.target.checked})} /><div><div className="text-sm font-bold text-black">æä¾›é¤é»ï¼Ÿ</div></div></label></div>
          </div>
          <div className="p-6 border-t bg-gray-50 flex gap-3"><button onClick={onClose} className="flex-1 bg-white border font-bold py-3 rounded-xl">å–æ¶ˆ</button><button onClick={handleSubmit} disabled={loading} className="flex-[2] bg-[#5cb85c] hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">{loading ? "è™•ç†ä¸­..." : "ç¢ºèªå‰µå»º"}</button></div>
        </div>
      </div>
    );
  };

  const DetailsRow = ({ activity, onClose, onCountUpdate }) => {
    const [details, setDetails] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    const fetchDetails = () => { setLoading(true); if (typeof google !== 'undefined') { google.script.run.withSuccessHandler((res) => { setDetails(res.error ? [] : res); setLoading(false); }).getActivityDetails(activity['æ´»å‹•è©¦ç®—è¡¨ID']); } else { setTimeout(() => { setDetails([{ "å ±åID": "R1", "å§“å": "æ¸¬è©¦äººå“¡", "é›»è©±": "0900", "æ ¸éŠ·ç‹€æ…‹": "æœªç°½åˆ°" }]); setLoading(false); }, 800); } };
    const handleCheckIn = (row) => {
      const newStatus = (row['æ ¸éŠ·ç‹€æ…‹'] === 'æœªç°½åˆ°' || row['æ ¸éŠ·ç‹€æ…‹'] === '') ? new Date().toLocaleString() : 'æœªç°½åˆ°';
      setDetails(prev => prev.map(d => d._row === row._row ? { ...d, 'æ ¸éŠ·ç‹€æ…‹': newStatus } : d));
      if (typeof google !== 'undefined') { google.script.run.toggleCheckInStatus(activity['æ´»å‹•è©¦ç®—è¡¨ID'], row._row, row['æ ¸éŠ·ç‹€æ…‹']); }
    };
    React.useEffect(() => { fetchDetails(); }, []);
    return (
      <tr className="bg-gray-50 border-b border-gray-200">
        <td colSpan="5" className="p-4">
          <div className="bg-white rounded-xl border border-blue-100 shadow-inner p-6">
            <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
              <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ“‚ å ±åæ˜ç´°ï¼š{activity['æ´»å‹•åç¨±']}</h3>
              <div className="flex gap-2"><button onClick={fetchDetails} className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold">åˆ·æ–°</button><button onClick={onClose} className="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-xs font-bold">é—œé–‰</button></div>
            </div>
            {loading ? <div className="text-center py-4 text-gray-400">è®€å–ä¸­...</div> : details.length === 0 ? <div className="text-center py-4 text-gray-400">å°šç„¡å ±å</div> : (
              <table className="w-full text-sm text-left">
                <thead><tr className="border-b text-gray-500"><th className="pb-2">å§“å</th><th className="pb-2">é›»è©±</th><th className="pb-2">ç‹€æ…‹</th><th className="pb-2">æ“ä½œ</th></tr></thead>
                <tbody>{details.map((row, idx) => (
                  <tr key={idx} className="border-b last:border-0"><td className="py-2 font-bold">{row['å§“å']}</td><td className="py-2">{row['é›»è©±']}</td><td className="py-2">{row['æ ¸éŠ·ç‹€æ…‹'] !== 'æœªç°½åˆ°' && row['æ ¸éŠ·ç‹€æ…‹'] !== '' ? <span className="text-green-600 font-bold bg-green-50 px-2 py-1 rounded border border-green-100 text-xs">{row['æ ¸éŠ·ç‹€æ…‹']}</span> : <span className="text-red-400 font-bold">æœªç°½åˆ°</span>}</td><td className="py-2"><button onClick={() => handleCheckIn(row)} className={`px-3 py-1 rounded text-xs text-white shadow-sm ${row['æ ¸éŠ·ç‹€æ…‹'] !== 'æœªç°½åˆ°' && row['æ ¸éŠ·ç‹€æ…‹'] !== '' ? 'bg-gray-400' : 'bg-[#428bca]'}`}>{row['æ ¸éŠ·ç‹€æ…‹'] !== 'æœªç°½åˆ°' && row['æ ¸éŠ·ç‹€æ…‹'] !== '' ? 'å–æ¶ˆ' : 'æ ¸éŠ·'}</button></td></tr>
                ))}</tbody>
              </table>
            )}
            <div className="mt-6 pt-4 border-t border-gray-100 flex justify-center"><button onClick={onClose} className="text-blue-500 font-bold text-sm">â†‘ æ”¶èµ·æ˜ç´°</button></div>
          </div>
        </td>
      </tr>
    );
  };

  const ActivityManagementModule = () => {
    const [list, setList] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    const [isModalOpen, setIsModalOpen] = React.useState(false);
    const [reclassifyTarget, setReclassifyTarget] = React.useState(null);
    const [lotteryTarget, setLotteryTarget] = React.useState(null);
    const [expandedId, setExpandedId] = React.useState(null);
    const [sortOrder, setSortOrder] = React.useState('latest');

    const refreshList = () => {
      setLoading(true);
      setExpandedId(null);
      if (typeof google !== 'undefined') {
        google.script.run.withSuccessHandler(res => { setList(res || []); setLoading(false); }).getActivityList();
      } else { setTimeout(() => { setList([{ "_row": 1, "æ´»å‹•åç¨±": "æ¼”ç¤ºæ´»å‹•", "å ±åäººæ•¸": 5, "æ ¸éŠ·äººæ•¸": 2, "æ´»å‹•è©¦ç®—è¡¨ID": "mock" }]); setLoading(false); }, 500); }
    };

    const handleDeactivate = (name) => {
      if (!confirm(`ç¢ºå®šè¦ä¸‹æ¶ã€Œ${name}ã€ï¼Ÿ`)) return;
      setLoading(true);
      google.script.run.withSuccessHandler(() => refreshList()).updateActivityStatus(name, "ä¸‹æ¶");
    };

    const handleCountUpdate = (activityId, delta) => {
      setList(prev => prev.map(a => a._row === activityId ? { ...a, 'æ ¸éŠ·äººæ•¸': parseInt(a['æ ¸éŠ·äººæ•¸']) + delta } : a));
    };

    const sortedList = React.useMemo(() => {
      return [...list].sort((a, b) => {
        const tA = new Date(a["èª²ç¨‹æ™‚é–“"] || 0).getTime();
        const tB = new Date(b["èª²ç¨‹æ™‚é–“"] || 0).getTime();
        return sortOrder === 'latest' ? tB - tA : tA - tB;
      });
    }, [list, sortOrder]);

    React.useEffect(() => { refreshList(); }, []);

    return (
      <div className="p-6">
        <CreateActivityModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSaved={refreshList} />
        <ReclassifyModal isOpen={!!reclassifyTarget} target={reclassifyTarget} onClose={() => setReclassifyTarget(null)} onConfirm={refreshList} />
        
        {/* Drawer å½¢å¼çš„æŠ½çé é¢ */}
        <LotteryDrawer 
          isOpen={!!lotteryTarget} 
          activity={lotteryTarget} 
          onClose={() => setLotteryTarget(null)} // åƒ…é—œé–‰ Drawerï¼Œä¸é‡æ•´åˆ—è¡¨
          onDataChange={refreshList} // æ–°å¢ï¼šåƒ…åœ¨è³‡æ–™è®Šæ›´æ™‚é‡æ•´
        />
        
        <div className="flex justify-between items-center mb-8">
          <div className="flex gap-4"><button onClick={() => setIsModalOpen(true)} className="bg-[#5cb85c] text-white px-6 py-3 rounded-xl font-bold shadow-md flex gap-2 active:scale-95"><IconPlus /> å‰µå»ºæ–°æ´»å‹•</button><button onClick={refreshList} className="bg-[#428bca] text-white px-6 py-3 rounded-xl font-bold shadow-md active:scale-95">ğŸ”„ é‡æ–°è¼‰å…¥</button></div>
          <div className="flex items-center gap-2 bg-white border border-gray-200 p-2 rounded-xl shadow-sm"><span className="text-sm font-bold text-gray-400 px-2 border-r">æ’åº</span><select value={sortOrder} onChange={e => setSortOrder(e.target.value)} className="text-sm font-bold text-gray-600 outline-none bg-transparent"><option value="latest">å»ºç«‹æ™‚é–“ (æœ€æ™š)</option><option value="earliest">å»ºç«‹æ™‚é–“ (æœ€æ—©)</option></select></div>
        </div>

        <div className="border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm">
          <table className="w-full text-sm">
            <thead><tr className="bg-gray-50 border-b text-gray-600"><th className="px-6 py-4 text-left font-bold border-r">æ´»å‹•åç¨±</th><th className="px-4 py-4 w-24 font-bold border-r text-center">å ±å</th><th className="px-4 py-4 w-24 font-bold border-r text-center">æ ¸éŠ·</th><th className="px-4 py-4 w-24 font-bold border-r text-center text-yellow-600">çé …</th><th className="px-6 py-4 font-bold text-center">æ“ä½œ</th></tr></thead>
            <tbody className="divide-y divide-gray-100">
              {loading ? <tr><td colSpan="5" className="p-20 text-center text-gray-400">è®€å–ä¸­...</td></tr> : sortedList.length === 0 ? <tr><td colSpan="5" className="p-20 text-center text-gray-400 italic">ç„¡è³‡æ–™</td></tr> : sortedList.map((act, i) => (
                <React.Fragment key={i}>
                  <tr className={`transition-colors ${expandedId === act._row ? 'bg-blue-50/50' : 'hover:bg-gray-50'}`}>
                    <td className="px-6 py-5 text-left font-bold text-gray-700 border-r border-gray-200">{act['æ´»å‹•åç¨±']}</td>
                    <td className="py-5 font-bold text-blue-600 border-r border-gray-200 text-center text-lg">{act['å ±åäººæ•¸']}</td>
                    <td className="py-5 text-center text-gray-600 border-r border-gray-200 text-lg">{act['æ ¸éŠ·äººæ•¸']}</td>
                    <td className="py-5 text-center text-yellow-600 border-r border-gray-200 text-lg font-bold">{act['çé …'] || 0}</td>
                    <td className="py-3 px-6">
                      <div className="flex flex-col items-center gap-2">
                        <div className="text-sm text-gray-600 mb-1 w-full text-center">èª²ç¨‹: <span className="font-bold">{act['èª²ç¨‹æ™‚é–“']}</span> | <span className="text-red-500 font-bold">æˆªæ­¢: {act['æˆªæ­¢æ—¥æœŸ']}</span></div>
                        <div className="flex justify-center gap-2">
                          <a href={act['å ±åå‰ç«¯ç¶²å€'] || "#"} target="_blank" className={`bg-[#10b981] text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm flex items-center ${(!act['å ±åå‰ç«¯ç¶²å€']) ? 'opacity-30' : ''}`}>ç¶²å€</a>
                          <button onClick={() => setExpandedId(expandedId === act._row ? null : act._row)} className={`px-4 py-2 rounded-lg text-xs font-bold shadow-sm ${expandedId === act._row ? 'bg-gray-500' : 'bg-[#428bca]'} text-white`}>{expandedId === act._row ? 'æ”¶èµ·' : 'æ˜ç´°'}</button>
                          <button onClick={() => setReclassifyTarget(act)} className="bg-[#6f42c1] text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm">åˆ†é¡</button>
                          <button onClick={() => handleDeactivate(act['æ´»å‹•åç¨±'])} className="bg-[#ef4444] text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm">ä¸‹æ¶</button>
                          <button onClick={() => setLotteryTarget(act)} className="bg-[#f0ad4e] text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm">æŠ½ç</button>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {expandedId === act._row && <DetailsRow activity={act} onClose={() => setExpandedId(null)} onCountUpdate={(delta) => handleCountUpdate(act._row, delta)} />}
                </React.Fragment>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };
  window.ActivityManagementModule = ActivityManagementModule;
</script>
