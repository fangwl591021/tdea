<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TDEA æ´»å‹•ç®¡ç†ç³»çµ± - æ¬Šé™é©—è­‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥ FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .fade-in { animation: fadeIn .4s ease-in-out forwards; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
    .hidden { display: none !important; }
    .btn-line { background: linear-gradient(to right, #06c755, #05b34c); }
    .btn-line:active { background: #049f43; transform: scale(0.98); }
    .input-field:focus { border-color: #06c755; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.2); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans text-gray-700">

  <!-- ğŸŸ¢ Loading / Splash ç•«é¢ -->
  <div id="splash" class="flex flex-col items-center justify-center w-full max-w-sm mx-auto text-center space-y-6 fade-in">
    <div class="relative w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-4">
      <i class="fa-solid fa-shield-halved text-4xl text-green-500"></i>
    </div>
    <div class="space-y-2">
      <h2 class="text-xl font-bold text-gray-800">TDEA æ´»å‹•ç®¡ç†ç³»çµ±</h2>
      <div class="flex items-center justify-center space-x-2 text-green-600 text-sm font-medium">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>æ¬Šé™é©—è­‰ä¸­...</span>
      </div>
    </div>
    <!-- Debug å€åŸŸï¼šé¡¯ç¤ºç›®å‰å‹•ä½œ -->
    <div id="debugInfo" class="text-xs text-gray-400 font-mono mt-8 px-4 break-all"></div>
  </div>

  <!-- â³ å¯©æ ¸ä¸­ç•«é¢ (æ–°å¢ï¼šé¡¯ç¤ºç›®å‰è³‡æ–™åº«è®€åˆ°çš„æ¬Šé™) -->
  <div id="pendingPage" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center hidden fade-in">
    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fa-solid fa-hourglass-half text-3xl text-yellow-600"></i>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">æ¬Šé™å¯©æ ¸ä¸­</h2>
    <p class="text-gray-600 mb-4">æ‚¨çš„ç”³è«‹å·²é€å‡ºï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡é–‹é€šã€‚</p>
    
    <!-- é¡¯ç¤ºç›®å‰ç‹€æ…‹ä¾›é™¤éŒ¯ -->
    <div class="bg-gray-50 rounded-lg p-4 text-left text-xs text-gray-500 mb-6 border border-gray-200">
      <p class="mb-1"><strong>ç”³è«‹äººï¼š</strong> <span id="pendingName">-</span></p>
      <p class="mb-1"><strong>ç›®å‰æ¬Šé™ï¼š</strong> <span id="currentRoleDisplay" class="text-red-500 font-bold">-</span></p>
      <p class="text-gray-400 mt-2 text-[10px]">è‹¥æ‚¨å·²æ˜¯ç®¡ç†å“¡ä½†çœ‹åˆ°æ­¤é é¢ï¼Œè«‹é€šçŸ¥å·¥ç¨‹å¸«æª¢æŸ¥è³‡æ–™åº«æ¬„ä½ã€‚</p>
    </div>

    <button onclick="window.location.reload()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">
      <i class="fa-solid fa-rotate-right mr-2"></i>é‡æ–°æ•´ç†ç‹€æ…‹
    </button>
  </div>

  <!-- â›” ç„¡æ¬Šé™ç•«é¢ -->
  <div id="accessDeniedPage" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center hidden fade-in">
    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fa-solid fa-ban text-3xl text-red-600"></i>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">ç„¡å­˜å–æ¬Šé™</h2>
    <p class="text-gray-600 mb-6">æ‚¨çš„å¸³è™Ÿæ¬Šé™ä¸è¶³æˆ–å·²è¢«åœç”¨ã€‚</p>
    <button onclick="window.close()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">
      é—œé–‰é é¢
    </button>
  </div>

  <!-- ğŸ“ è¨»å†Šè¡¨å–® -->
  <div id="registerForm" class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden hidden fade-in">
    <div class="bg-green-500 p-6 text-center text-white relative">
        <h1 class="text-xl font-bold tracking-wide">å¾Œå°æ¬Šé™ç”³è«‹</h1>
        <p class="text-green-100 text-sm mt-1">è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥ä¾›å¯©æ ¸</p>
        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2">
            <div class="w-16 h-16 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-md">
                <img id="userAvatar" src="https://via.placeholder.com/150" alt="Avatar" class="w-full h-full object-cover">
            </div>
        </div>
    </div>

    <div class="pt-12 pb-8 px-6 space-y-4">
      <div class="text-center mb-4">
        <p id="displayName" class="font-bold text-gray-800 text-lg">è¼‰å…¥ä¸­...</p>
        <div class="mt-2 p-2 bg-blue-50 text-blue-700 text-xs rounded-lg border border-blue-100">
          <i class="fa-solid fa-circle-info mr-1"></i> æäº¤å¾Œéœ€äººå·¥æ ¸å‡†æ‰èƒ½ç™»å…¥
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">çœŸå¯¦å§“å</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-regular fa-user text-gray-400"></i>
            </div>
            <input id="name" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" 
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-phone text-gray-400"></i>
            </div>
            <input id="phone" type="tel" placeholder="0912345678" maxlength="10"
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <div class="pt-4">
        <button id="registerBtn" onclick="registerUser()" class="btn-line w-full text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-green-200 transition-all flex items-center justify-center space-x-2">
            <span id="btnText">æäº¤ç”³è«‹</span>
            <div id="btnSpinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
        </button>
      </div>
    </div>
  </div>

<script>
/* ==========================================
   âš™ï¸ ç³»çµ±è¨­å®š
   ========================================== */
const LIFF_ID        = '2005868456-cfANNVou';     
const WORKER_URL     = 'https://delicate-math-7e61.fangwl591021.workers.dev/'; 
const NEXT_PAGE      = 'main.html';
const SPREADSHEET_ID = '1qJ900hzX1nuN4D2wprXtoknfWOfU8wFrRd4-T3eiGkA';

/* ==========================================
   ğŸ› ï¸ å·¥å…·
   ========================================== */
const $ = id => document.getElementById(id);
const mask = u => u ? (u.slice(0,8)+'****') : '';
function updateDebug(msg){ 
    console.log('ğŸ”', msg); 
    // è‹¥è¦é¡¯ç¤ºåœ¨ç•«é¢ä¸Šé™¤éŒ¯ï¼Œè«‹ç§»é™¤ä¸‹è¡Œè¨»è§£
    // $('debugInfo').innerHTML = msg;
}

function showPage(pageId) {
    ['splash', 'registerForm', 'pendingPage', 'accessDeniedPage'].forEach(id => {
        $(id).classList.add('hidden');
    });
    $(pageId).classList.remove('hidden');
}

function setBtnLoading(isLoading) {
    const btn = $('registerBtn');
    btn.disabled = isLoading;
    if (isLoading) {
        $('btnText').classList.add('hidden');
        $('btnSpinner').classList.remove('hidden');
        btn.classList.add('opacity-70', 'cursor-not-allowed');
    } else {
        $('btnText').classList.remove('hidden');
        $('btnSpinner').classList.add('hidden');
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
    }
}

let currentUserId = null;
let userProfile = null;

/* ==========================================
   ğŸš€ åˆå§‹åŒ–æµç¨‹ (å¼·åˆ¶æ¸…é™¤è¨˜æ†¶)
   ========================================== */
(async function initApp() {
    try {
        // ğŸ›‘ å¼·åˆ¶æ¸…é™¤ LocalStorageï¼Œé˜²æ­¢ã€Œè¨˜ä½ã€èˆŠç‹€æ…‹
        localStorage.clear();
        updateDebug('æ¸…é™¤å¿«å–å®Œæˆï¼Œå•Ÿå‹•åˆå§‹åŒ–...');

        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: location.href });
            return;
        }

        userProfile = await liff.getProfile();
        currentUserId = userProfile.userId;
        updateDebug('Line User: ' + userProfile.displayName);
        
        // é å¡« UI
        $('displayName').textContent = userProfile.displayName;
        if (userProfile.pictureUrl) $('userAvatar').src = userProfile.pictureUrl;
        $('name').value = userProfile.displayName;

        // ğŸŸ¢ åŸ·è¡Œåš´æ ¼æ¬Šé™æª¢æŸ¥
        await checkPermission(currentUserId);

    } catch (err) {
        console.error('Error:', err);
        alert('ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤ï¼š' + err.message);
    }
})();

// ğŸ“¡ æ¬Šé™æª¢æŸ¥ (åš´æ ¼ç™½åå–® + ç¦ç”¨å¿«å–)
async function checkPermission(userId) {
    updateDebug('å‘ä¼ºæœå™¨æª¢æŸ¥æ¬Šé™ä¸­...');
    
    try {
        // ğŸŸ¢ åŠ ä¸Š timestamp é˜²æ­¢ fetch å¿«å–èˆŠè³‡æ–™
        const timestamp = new Date().getTime();
        const checkUrl = `${WORKER_URL}?mode=check&userId=${encodeURIComponent(userId)}&spreadsheetId=${encodeURIComponent(SPREADSHEET_ID)}&_t=${timestamp}`;
        
        const response = await fetch(checkUrl);
        const result = await response.json();
        
        updateDebug('ä¼ºæœå™¨å›æ‡‰: ' + JSON.stringify(result));

        // 1. åˆ¤æ–·æ˜¯å¦è¨»å†Š
        const isRegistered = (result.data && result.data.registered === true) || (result.registered === true);
        
        // 2. åš´æ ¼æå–æ¬Šé™
        let role = '';
        const userData = result.data || result.user || {};
        
        if (userData.role) role = userData.role;
        else if (userData['æ¬Šé™']) role = userData['æ¬Šé™'];
        
        // å¦‚æœæ¬Šé™æ˜¯ undefined æˆ– nullï¼Œè¨­ç‚ºç©ºå­—ä¸²ï¼Œé¿å…éŒ¯èª¤
        if (!role) role = 'ç„¡';

        updateDebug(`åˆ¤å®šçµæœ -> è¨»å†Š:${isRegistered}, æ¬Šé™:${role}`);

        if (isRegistered) {
            // âœ… åªæœ‰ã€Œç®¡ç†å“¡ã€æ‰èƒ½é€²å…¥
            if (role === 'ç®¡ç†å“¡' || role === 'Admin') {
                updateDebug('âœ… é©—è­‰é€šé');
                setTimeout(() => window.location.replace(NEXT_PAGE), 500);
            } 
            else {
                // ğŸ›‘ å…¶ä»–æ‰€æœ‰æƒ…æ³ (å¾…å¯©æ ¸ã€è¢«æ‹’çµ•ã€ç©ºå€¼) éƒ½æ“‹ä¸‹
                updateDebug('â³ æ¬Šé™ä¸è¶³ï¼Œé¡¯ç¤ºå¯©æ ¸é ');
                $('pendingName').textContent = userData.name || userData.displayName || userProfile.displayName;
                $('currentRoleDisplay').textContent = role; // é¡¯ç¤ºç›®å‰æŠ“åˆ°çš„æ¬Šé™ï¼Œæ–¹ä¾¿é™¤éŒ¯
                showPage('pendingPage');
            }
        } else {
            // ğŸ“ æœªè¨»å†Š -> é¡¯ç¤ºè¡¨å–®
            updateDebug('æœªè¨»å†Šï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®');
            showPage('registerForm');
        }

    } catch (err) {
        updateDebug('æª¢æŸ¥å¤±æ•—: ' + err.message);
        // å¦‚æœé€£ç·šå¤±æ•—ï¼Œä¿å®ˆèµ·è¦‹é¡¯ç¤ºè¡¨å–®ï¼Œä¸è¦æ”¾è¡Œ
        showPage('registerForm');
    }
}

/* ==========================================
   ğŸ“ è¨»å†Š (é€å‡ºå¾Œåƒ…é¡¯ç¤ºç­‰å¾…ç•«é¢)
   ========================================== */
async function registerUser() {
    const name = $('name').value.trim();
    const phone = $('phone').value.trim();

    if (!name || !phone) { alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™'); return; }
    if (!/^09\d{8}$/.test(phone)) { alert('è«‹è¼¸å…¥æ­£ç¢ºæ‰‹æ©Ÿè™Ÿç¢¼'); return; }

    const payload = {
        type: 'register',
        mode: 'register',
        action: 'register',
        spreadsheetId: SPREADSHEET_ID,
        userId: currentUserId,
        name: name,
        displayName: name,
        phone: phone,
        
        // ğŸŸ¢ å¯«å…¥æ¬Šé™ç‚º "å¾…å¯©æ ¸"
        role: 'å¾…å¯©æ ¸',
        "å§“å": name,
        "é›»è©±": phone,
        "æ¬Šé™": "å¾…å¯©æ ¸",
        "Line UserID": currentUserId,
        
        studentId: '-',
        department: '-',
        pictureUrl: userProfile?.pictureUrl || '',
        timestamp: new Date().toISOString()
    };

    setBtnLoading(true);

    try {
        // åŒæ¨£åŠ ä¸Š timestamp é˜²æ­¢å¿«å–
        const timestamp = new Date().getTime();
        const postUrl = `${WORKER_URL}?spreadsheetId=${encodeURIComponent(SPREADSHEET_ID)}&_t=${timestamp}`;
        
        const response = await fetch(postUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (result.ok || result.status === 'success' || result.success) {
            alert('âœ… ç”³è«‹å·²é€å‡ºï¼\n\nç³»çµ±å°‡è·³è½‰è‡³ç‹€æ…‹é é¢ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡æ ¸å‡†æ¬Šé™ã€‚');
            
            // ğŸŸ¢ æ›´æ–°ç‹€æ…‹é è³‡è¨Šï¼Œä¸¦é¡¯ç¤º
            $('pendingName').textContent = name;
            $('currentRoleDisplay').textContent = 'å¾…å¯©æ ¸ (å‰›æäº¤)';
            showPage('pendingPage');
            
            // ğŸ›‘ çµ•å°ä¸è¦åœ¨é€™è£¡è·³è½‰ main.html
        } else {
            throw new Error(result.message || result.error || 'ç„¡æ³•å¯«å…¥è³‡æ–™åº«');
        }

    } catch (err) {
        alert('è¨»å†Šå¤±æ•—ï¼š' + err.message);
    } finally {
        setBtnLoading(false);
    }
}
</script>
</body>
</html>
