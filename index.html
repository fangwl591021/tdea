<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TDEA æ´»å‹•ç®¡ç†ç³»çµ± - ç®¡ç†å“¡è¨»å†Š</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥ FontAwesome åœ–æ¨™ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* å‹•ç•«è¨­å®š */
    .fade-in { animation: fadeIn .4s ease-in-out forwards; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
    .hidden { display: none !important; }
    
    /* LINE é¢¨æ ¼ç¶ è‰²æŒ‰éˆ•æ¼¸å±¤ */
    .btn-line { background: linear-gradient(to right, #06c755, #05b34c); }
    .btn-line:active { background: #049f43; transform: scale(0.98); }
    
    /* è¼¸å…¥æ¡†èšç„¦æ¨£å¼ */
    .input-field:focus { border-color: #06c755; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.2); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans text-gray-700">

  <!-- ğŸŸ¢ Loading / Splash ç•«é¢ -->
  <div id="splash" class="flex flex-col items-center justify-center w-full max-w-sm mx-auto text-center space-y-6 fade-in">
    <div class="relative w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-4">
      <i class="fa-solid fa-calendar-check text-4xl text-green-500"></i>
    </div>
    <div class="space-y-2">
      <h2 class="text-xl font-bold text-gray-800">TDEA æ´»å‹•ç®¡ç†ç³»çµ±</h2>
      <div class="flex items-center justify-center space-x-2 text-green-600 text-sm font-medium">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>ç³»çµ±é€£ç·šä¸­...</span>
      </div>
    </div>
    <div id="debugInfo" class="text-xs text-gray-400 font-mono mt-8 px-4 break-all"></div>
  </div>

  <!-- ğŸ“ è¨»å†Šè¡¨å–® (é è¨­éš±è—) -->
  <div id="registerForm" class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden hidden fade-in">
    <!-- è¡¨å–®é ­éƒ¨ -->
    <div class="bg-green-500 p-6 text-center text-white relative">
        <h1 class="text-xl font-bold tracking-wide">ç®¡ç†å“¡è³‡æ–™è¨»å†Š</h1>
        <p class="text-green-100 text-sm mt-1">è«‹ç¢ºèªæ‚¨çš„åŸºæœ¬è³‡æ–™</p>
        
        <!-- å¤§é ­è²¼é¡¯ç¤ºå€ -->
        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2">
            <div class="w-16 h-16 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-md">
                <img id="userAvatar" src="https://via.placeholder.com/150" alt="Avatar" class="w-full h-full object-cover">
            </div>
        </div>
    </div>

    <!-- è¡¨å–®å…§å®¹ -->
    <div class="pt-12 pb-8 px-6 space-y-4">
      
      <!-- é¡¯ç¤º User ID -->
      <div class="text-center mb-4">
        <p id="displayName" class="font-bold text-gray-800 text-lg">è¼‰å…¥ä¸­...</p>
        <p id="userIdDisplay" class="text-xs text-gray-400 font-mono"></p>
        <span class="inline-block mt-1 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full">ç”³è«‹æ¬Šé™ï¼šç®¡ç†å“¡</span>
      </div>

      <!-- å§“åæ¬„ä½ -->
      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">çœŸå¯¦å§“å</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-regular fa-user text-gray-400"></i>
            </div>
            <input id="name" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" 
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <!-- é›»è©±æ¬„ä½ -->
      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-phone text-gray-400"></i>
            </div>
            <input id="phone" type="tel" placeholder="0912345678" maxlength="10"
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <!-- æŒ‰éˆ•å€åŸŸ -->
      <div class="pt-4">
        <button id="registerBtn" onclick="registerUser()" class="btn-line w-full text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-green-200 transition-all flex items-center justify-center space-x-2">
            <span id="btnText">ç¢ºèªè¨»å†Š</span>
            <div id="btnSpinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
        </button>
      </div>
      
      <p class="text-center text-xs text-gray-400 mt-4">
        é»æ“Šè¨»å†Šå³è¡¨ç¤ºæ‚¨åŒæ„æœ¬ç³»çµ±çš„ä½¿ç”¨æ¢æ¬¾
      </p>
    </div>
  </div>

<script>
/* ==========================================
   âš™ï¸ ç³»çµ±è¨­å®šå€
   ========================================== */
const LIFF_ID        = '2005868456-cfANNVou';     
const WORKER_URL     = 'https://delicate-math-7e61.fangwl591021.workers.dev/'; 
const NEXT_PAGE      = 'main.html';
// ğŸ”¹ æŒ‡å®šå¯«å…¥çš„ Google Sheet ID
const SPREADSHEET_ID = '1qJ900hzX1nuN4D2wprXtoknfWOfU8wFrRd4-T3eiGkA';

/* ==========================================
   ğŸ› ï¸ å·¥å…·å‡½å¼åº«
   ========================================== */
const $ = id => document.getElementById(id);
const mask = u => u ? (u.slice(0,8)+'****') : '';

// Debug è¨Šæ¯é¡¯ç¤º
function updateDebug(msg){ 
    console.log('ğŸ”', msg);
}

// UI åˆ‡æ›
function showForm() {
    $('splash').classList.add('hidden');
    $('registerForm').classList.remove('hidden');
}

// æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
function setBtnLoading(isLoading) {
    const btn = $('registerBtn');
    const text = $('btnText');
    const spinner = $('btnSpinner');
    
    btn.disabled = isLoading;
    if (isLoading) {
        text.classList.add('hidden');
        spinner.classList.remove('hidden');
        btn.classList.add('opacity-70', 'cursor-not-allowed');
    } else {
        text.classList.remove('hidden');
        spinner.classList.add('hidden');
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
    }
}

// å…¨åŸŸè®Šæ•¸
let currentUserId = null;
let userProfile = null;

/* ==========================================
   ğŸš€ ä¸»ç¨‹å¼æµç¨‹
   ========================================== */
(async function initApp() {
    try {
        updateDebug('å•Ÿå‹• LIFF åˆå§‹åŒ–...');
        
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
            updateDebug('å°šæœªç™»å…¥ï¼Œå°å‘ LINE ç™»å…¥é é¢...');
            liff.login({ redirectUri: location.href });
            return;
        }

        userProfile = await liff.getProfile();
        currentUserId = userProfile.userId;
        
        updateDebug('å–å¾—ç”¨æˆ¶: ' + userProfile.displayName);
        
        $('userIdDisplay').textContent = `ID: ${mask(currentUserId)}`;
        $('displayName').textContent = userProfile.displayName;
        if (userProfile.pictureUrl) {
            $('userAvatar').src = userProfile.pictureUrl;
        }
        $('name').value = userProfile.displayName;

        // æª¢æŸ¥å¾Œç«¯è¨»å†Šç‹€æ…‹æ™‚ï¼Œä¹Ÿå¸¶ä¸Š spreadsheetId ä»¥é˜²å¾Œç«¯éœ€è¦
        await checkRegistrationStatus(currentUserId);

    } catch (err) {
        console.error('App Error:', err);
        updateDebug('âŒ ç™¼ç”ŸéŒ¯èª¤: ' + err.message);
        alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚\n' + err.message);
    }
})();

// ğŸ“¡ æª¢æŸ¥è¨»å†Šç‹€æ…‹
async function checkRegistrationStatus(userId) {
    updateDebug('æ­£åœ¨æª¢æŸ¥è¨»å†Šç‹€æ…‹...');
    try {
        // å¸¶ä¸Š spreadsheetId åƒæ•¸ (å¦‚æœå¾Œç«¯æœ‰æ”¯æ´å¤šè¡¨åˆ‡æ›)
        const checkUrl = `${WORKER_URL}?mode=check&userId=${encodeURIComponent(userId)}&spreadsheetId=${encodeURIComponent(SPREADSHEET_ID)}`;
        const response = await fetch(checkUrl);
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        const isRegistered = (result.data && result.data.registered === true) || 
                             (result.registered === true);

        if (isRegistered) {
            updateDebug('âœ… å·²è¨»å†Šï¼Œè·³è½‰ä¸­...');
            localStorage.setItem('tdea_user', JSON.stringify(result.data || result.user));
            setTimeout(() => {
                window.location.replace(NEXT_PAGE);
            }, 1000);
        } else {
            updateDebug('ğŸ“ æœªè¨»å†Šï¼Œé¡¯ç¤ºè¡¨å–®');
            showForm();
        }

    } catch (err) {
        updateDebug('âš ï¸ API é€£ç·šå¤±æ•—ï¼Œé è¨­é¡¯ç¤ºè¡¨å–®: ' + err.message);
        console.warn('API Error, falling back to form', err);
        showForm(); 
    }
}

/* ==========================================
   ğŸ“ è¨»å†Šå‹•ä½œ
   ========================================== */
async function registerUser() {
    const name = $('name').value.trim();
    const phone = $('phone').value.trim();

    // é©—è­‰
    if (!name || !phone) {
        alert('è«‹å¡«å¯«å§“åèˆ‡æ‰‹æ©Ÿè™Ÿç¢¼');
        return;
    }
    if (!/^09\d{8}$/.test(phone)) {
        alert('è«‹è¼¸å…¥æ­£ç¢ºçš„ 10 ç¢¼æ‰‹æ©Ÿæ ¼å¼');
        return;
    }

    // æº–å‚™è³‡æ–™
    const payload = {
        mode: 'registerUser',
        spreadsheetId: SPREADSHEET_ID, // ğŸ”¹ å‚³é€æŒ‡å®šçš„ Google Sheet ID
        userId: currentUserId,         // ğŸ”¹ LINE UserID
        displayName: name,             // ğŸ”¹ å§“å
        phone: phone,                  // ğŸ”¹ é›»è©±
        role: 'ç®¡ç†å“¡',                 // ğŸ”¹ æ¬Šé™ (é è¨­å¯«å…¥ç®¡ç†å“¡)
        pictureUrl: userProfile?.pictureUrl || '',
        timestamp: new Date().toISOString()
    };

    setBtnLoading(true);

    try {
        updateDebug('é€å‡ºè¨»å†Šè³‡æ–™...');
        console.log('Payload:', payload); // é™¤éŒ¯ç”¨
        
        const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        updateDebug('è¨»å†Šå›æ‡‰: ' + JSON.stringify(result));

        if (result.ok || result.status === 'success' || result.success) {
            $('btnText').textContent = 'è¨»å†ŠæˆåŠŸï¼';
            localStorage.setItem('tdea_registered', 'true');
            setTimeout(() => {
                window.location.href = NEXT_PAGE;
            }, 1000);
        } else {
            throw new Error(result.message || result.error || 'ä¼ºæœå™¨å›å‚³å¤±æ•—');
        }

    } catch (err) {
        console.error('Register Error:', err);
        alert('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼š' + err.message);
        setBtnLoading(false);
    }
}

// ğŸ§ª é–‹ç™¼æ¸¬è©¦ç”¨
if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
    window.addEventListener('load', () => {
        setTimeout(() => {
            if(!$('name').value) $('name').value = 'æ¸¬è©¦ç®¡ç†å“¡';
            $('phone').value = '0912345678';
            console.log('ğŸ§ª é–‹ç™¼æ¨¡å¼ï¼šå·²è‡ªå‹•å¡«å¯«æ¸¬è©¦è³‡æ–™');
        }, 1000);
    });
}
</script>
</body>
</html>
