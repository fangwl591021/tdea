<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDEA ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext } = React;
        
        // âš ï¸ è«‹ç¢ºèªé€™å…©é …è¨­å®š
        const LIFF_ID = "2005868456-cfANNVou"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzY-CJEeIEJob3SJ_XNKV1u-Rv5JdaN56vpZq1o0e9OeUb88hqnEYWaC0FUa6CnudC4/exec";

        const UserContext = createContext(null);

        // API å‘¼å« (å¼·åˆ¶é˜²å¿«å–)
        async function callAPI(action, data = {}) {
            try {
                const url = `${GAS_URL}?t=${new Date().getTime()}`;
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({ action, ...data })
                });
                return await response.json();
            } catch (err) {
                return { success: false, message: "é€£ç·šå¤±æ•—: " + err.message };
            }
        }

        const IconBase = ({children}) => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{children}</svg>;
        const BarChart2 = () => <IconBase><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const Users = () => <IconBase><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></IconBase>;
        const LogOut = () => <IconBase><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/></IconBase>;

        const AuthGuard = ({ children }) => {
            const [status, setStatus] = useState("LOADING"); 
            const [userProfile, setUserProfile] = useState(null);
            const [debugInfo, setDebugInfo] = useState(null); // å„²å­˜å¾Œç«¯å›å‚³çš„åŸå§‹è³‡æ–™
            const [regForm, setRegForm] = useState({ name: '', phone: '' });
            const [regLoading, setRegLoading] = useState(false);

            useEffect(() => {
                const init = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (!liff.isLoggedIn()) { liff.login(); return; }
                        
                        const profile = await liff.getProfile();
                        setUserProfile(profile);
                        setRegForm(prev => ({ ...prev, name: profile.displayName }));
                        
                        // ğŸ” å‘¼å«å¾Œç«¯æª¢æŸ¥
                        const res = await callAPI('check', { userId: profile.userId });
                        setDebugInfo(res); // å„²å­˜å›æ‡‰ä»¥ä¾›é¡¯ç¤º

                        if (res.status === 'ok') {
                            setStatus("AUTHORIZED");
                        } else if (res.status === 'pending') {
                            setStatus("PENDING");
                        } else {
                            setStatus("REGISTER");
                        }
                    } catch (err) { 
                        setStatus("ERROR");
                        setDebugInfo({ error: err.toString() });
                    }
                };
                init();
            }, []);

            const handleRegister = async () => {
                if (!regForm.name || !regForm.phone) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
                setRegLoading(true);
                const res = await callAPI('register', { userId: userProfile.userId, name: regForm.name, phone: regForm.phone });
                setRegLoading(false);
                setDebugInfo(res); // æ›´æ–° Debug è³‡è¨Š
                if (res.success) setStatus("PENDING");
                else alert("è¨»å†Šå¤±æ•—: " + res.message);
            };

            if (status === "LOADING") return <div className="h-screen flex items-center justify-center text-gray-500 font-bold">ç³»çµ±é€£ç·šä¸­...</div>;
            
            if (status === "REGISTER" || status === "PENDING") return (
                <div className="h-screen flex flex-col items-center justify-center bg-gray-50 p-6 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center mb-6">
                        <div className="text-5xl mb-4">{status === "REGISTER" ? "ğŸ“" : "â³"}</div>
                        <h2 className="text-2xl font-black mb-2 text-gray-800">{status === "REGISTER" ? "ç”³è«‹æ“ä½œæ¬Šé™" : "æ¬Šé™å¯©æ ¸ä¸­"}</h2>
                        
                        {status === "REGISTER" ? (
                            <div className="space-y-4 text-left mt-6">
                                <input className="w-full border p-3 rounded-xl bg-gray-50" value={regForm.name} onChange={e => setRegForm({...regForm, name: e.target.value})} placeholder="å§“å" />
                                <input className="w-full border p-3 rounded-xl bg-gray-50" value={regForm.phone} onChange={e => setRegForm({...regForm, phone: e.target.value})} placeholder="é›»è©±" />
                                <button onClick={handleRegister} disabled={regLoading} className="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg">
                                    {regLoading ? "è™•ç†ä¸­..." : "æäº¤ç”³è«‹"}
                                </button>
                            </div>
                        ) : (
                            <div className="mt-4">
                                <p className="text-gray-500 mb-6">è³‡æ–™å·²é€å‡ºï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡é–‹é€šã€‚</p>
                                <button onClick={() => window.location.reload()} className="w-full bg-blue-50 text-blue-600 py-3 rounded-xl font-bold">å·²é–‹é€šï¼Ÿé»æ­¤åˆ·æ–°</button>
                            </div>
                        )}
                    </div>

                    {/* ğŸ•µï¸â€â™‚ï¸ è¨ºæ–·å„€è¡¨æ¿ï¼šé€™æ˜¯çµ¦æ‚¨çœ‹çš„ï¼Œæ‰¾å‡ºç‚ºä»€éº¼éä¸å» */}
                    <div className="w-full max-w-sm bg-gray-900 text-green-400 p-4 rounded-xl text-xs font-mono break-all opacity-90 shadow-lg">
                        <p className="text-white font-bold border-b border-gray-700 pb-2 mb-2">ğŸ”§ ç³»çµ±è¨ºæ–·è³‡è¨Š (Debug)</p>
                        <p><span className="text-gray-500">æ‚¨çš„ ID:</span> {userProfile?.userId}</p>
                        <p className="mt-2"><span className="text-gray-500">å¾Œç«¯å›æ‡‰ç‹€æ…‹:</span> {debugInfo?.status}</p>
                        
                        {/* é€™è£¡æœ€é‡è¦ï¼šé¡¯ç¤ºå¾Œç«¯åˆ°åº•è®€åˆ°äº†ä»€éº¼æ¬Šé™æ–‡å­— */}
                        {debugInfo?.debug_role_read && (
                            <p className="bg-red-900/50 text-white p-2 mt-2 rounded border border-red-500">
                                âš ï¸ ç³»çµ±è®€åˆ°çš„æ¬Šé™æ–‡å­—ï¼š[{debugInfo.debug_role_read}]<br/>
                                (è‹¥æ­¤è™•éã€Œæ ¸å‡†ã€ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ D æ¬„)
                            </p>
                        )}
                        
                        <p className="mt-2 text-gray-600">å®Œæ•´å›æ‡‰: {JSON.stringify(debugInfo)}</p>
                    </div>
                </div>
            );

            if (status === "ERROR") return <div className="p-10 text-center text-red-500">éŒ¯èª¤: {JSON.stringify(debugInfo)}</div>;

            return <UserContext.Provider value={{...userProfile}}>{children}</UserContext.Provider>;
        };

        const Dashboard = () => {
            const [stats, setStats] = useState({ activityCount: '-', assocCount: '-', vendorCount: '-' });
            useEffect(() => { callAPI('getDashboardSummary').then(res => { if(res.success) setStats(res.stats); }); }, []);
            return (
                <div className="p-8 fade-in">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><BarChart2 /> ç³»çµ±æ¦‚è¦½</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border"><p className="text-gray-400 text-xs font-bold">ä¸Šæ¶æ´»å‹•</p><h3 className="text-2xl font-black text-green-600">{stats.activityCount}</h3></div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border"><p className="text-gray-400 text-xs font-bold">å”æœƒæœƒå“¡</p><h3 className="text-2xl font-black text-blue-600">{stats.assocCount}</h3></div>
                    </div>
                </div>
            );
        };

        const MemberTable = ({ title, sheetName }) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                setLoading(true);
                callAPI('getMemberData', { sheetName }).then(res => { setData(res.data || []); setLoading(false); });
            }, [sheetName]);
            return (
                <div className="p-8 fade-in">
                    <h2 className="text-2xl font-black text-gray-800 mb-6">{title}</h2>
                    <div className="bg-white rounded-2xl shadow-sm border overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50 border-b"><tr><th className="p-4">ç·¨è™Ÿ</th><th className="p-4">å§“å</th><th className="p-4">æ¬¡æ•¸</th></tr></thead>
                            <tbody>{loading ? <tr><td colSpan="3" className="p-8 text-center text-gray-400">è¼‰å…¥ä¸­...</td></tr> : data.map((i,x) => <tr key={x} className="border-b"><td className="p-4 text-center font-mono text-blue-600">{i["ç·¨è™Ÿ"]||i["æœƒå“¡ç·¨è™Ÿ"]}</td><td className="p-4 text-center font-bold">{i["å§“å"]||i["å…¬å¸"]}</td><td className="p-4 text-center">{i["å ±åæ¬¡æ•¸"]||0}</td></tr>)}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const user = useContext(UserContext);
            return (
                <AuthGuard>
                    <div className="flex h-screen overflow-hidden">
                        <div className="w-64 sidebar-bg text-gray-300 flex flex-col shrink-0">
                            <div className="p-8 border-b border-gray-700 text-[#4ade80] text-2xl font-bold text-center italic tracking-widest">TDEA Hub</div>
                            <nav className="flex-1 mt-6">
                                <div className={`px-6 py-4 cursor-pointer flex items-center gap-3 ${view === 'dashboard' ? 'active-item' : 'menu-item'}`} onClick={() => setView('dashboard')}><BarChart2 /><span>ç¸½è¦½</span></div>
                                <div className={`px-6 py-4 cursor-pointer flex items-center gap-3 ${view === 'assoc' ? 'active-item' : 'menu-item'}`} onClick={() => setView('assoc')}><Users /><span>å”æœƒåå†Š</span></div>
                            </nav>
                            <div className="border-t border-gray-700 bg-[#22272e] p-6 text-center">
                                <div className="text-white font-bold text-sm mb-4">{user?.displayName}</div>
                                <button onClick={() => {liff.logout(); window.location.reload();}} className="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs font-bold"><LogOut /> ç™»å‡º</button>
                            </div>
                        </div>
                        <main className="flex-1 overflow-auto bg-[#f8fafc] no-scrollbar">
                            {view === 'dashboard' && <Dashboard />}
                            {view === 'assoc' && <MemberTable title="å”æœƒæœƒå“¡" sheetName="æœ¬æ¥­æœƒå“¡" />}
                        </main>
                    </div>
                </AuthGuard>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
