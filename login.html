<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TDEA æ´»å‹•å°ˆå€</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .bg-gradient-custom { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-focus:focus { border-color: #10b981; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .step-inactive { filter: grayscale(1); opacity: 0.5; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-5">

    <!-- ğŸŸ¢ 1. è¼‰å…¥ä¸­ç‹€æ…‹ -->
    <div id="loadingPage" class="flex flex-col items-center space-y-4 fade-in">
        <div class="w-16 h-16 border-4 border-emerald-100 border-t-emerald-600 rounded-full animate-spin"></div>
        <p class="text-emerald-800 font-bold tracking-widest">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <!-- ğŸŸ¢ 2. ç™»å…¥/è¨»å†Šè¡¨å–® (æœªç¶å®šæ™‚é¡¯ç¤º) -->
    <div id="registerForm" class="hidden w-full max-w-md space-y-6 fade-in">
        <div class="text-center space-y-2 mb-8">
            <div class="w-20 h-20 bg-gradient-custom rounded-3xl shadow-xl flex items-center justify-center mx-auto mb-4 rotate-3">
                <i class="fa-solid fa-calendar-check text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-black text-emerald-900 tracking-tighter">æ´»å‹•å°ˆå€ç¶å®š</h1>
            <p class="text-gray-500 font-medium">è«‹å®Œæˆè³‡æ–™é©—è­‰ä»¥å ±åæ´»å‹•</p>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <!-- LINE è³‡è¨Š -->
            <div class="flex items-center gap-4 p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                <img id="userPicture" class="w-12 h-12 rounded-full border-2 border-white shadow-sm" src="" alt="">
                <div>
                    <p class="text-xs text-emerald-600 font-bold">LINE å¸³è™Ÿé€£å‹•ä¸­</p>
                    <p id="userName" class="font-black text-gray-800">-</p>
                </div>
            </div>

            <!-- èº«åˆ†é¸æ“‡ -->
            <div class="space-y-2">
                <label class="text-sm font-black text-gray-400 ml-1 uppercase">èº«åˆ†è­˜åˆ¥</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setType('æœ¬æ¥­æœƒå“¡')" id="btnAssoc" class="py-3 rounded-2xl font-bold border-2 transition-all border-gray-100 bg-gray-50 text-gray-400">å”æœƒæœƒå“¡</button>
                    <button onclick="setType('å» å•†æœƒå“¡')" id="btnVendor" class="py-3 rounded-2xl font-bold border-2 transition-all border-gray-100 bg-gray-50 text-gray-400">å» å•†æœƒå“¡</button>
                </div>
                <button onclick="setType('éæœƒå“¡')" id="btnGuest" class="w-full py-3 rounded-2xl font-bold border-2 transition-all border-gray-100 bg-gray-50 text-gray-400 mt-2">éæœƒå“¡ / ä¸€èˆ¬å¤§çœ¾</button>
            </div>

            <!-- æœƒå“¡ç·¨è™Ÿ (åƒ…æœƒå“¡é¡¯ç¤º) -->
            <div id="memberIdArea" class="hidden space-y-2">
                <label class="text-sm font-black text-gray-400 ml-1 uppercase">æœƒå“¡ç·¨è™Ÿ</label>
                <div class="relative">
                    <input id="memberId" type="text" placeholder="è«‹è¼¸å…¥åå†Šä¸Šçš„ç·¨è™Ÿ" class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl font-black text-lg outline-none input-focus transition-all">
                    <i class="fa-solid fa-id-card absolute right-4 top-5 text-gray-300"></i>
                </div>
            </div>

            <!-- è¯çµ¡é›»è©± -->
            <div class="space-y-2">
                <label class="text-sm font-black text-gray-400 ml-1 uppercase">è¯çµ¡æ‰‹æ©Ÿ</label>
                <div class="relative">
                    <input id="userPhone" type="tel" placeholder="0912345678" maxlength="10" class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-2xl font-black text-lg outline-none input-focus transition-all">
                    <i class="fa-solid fa-mobile-screen absolute right-4 top-5 text-gray-300"></i>
                </div>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <button id="submitBtn" onclick="handleBind()" class="w-full bg-gradient-custom text-white py-5 rounded-[1.5rem] font-black text-xl shadow-lg shadow-emerald-200 active:scale-95 transition-all">
                <span id="btnText">ç¢ºèªç¶å®šä¸¦é€²å…¥</span>
                <i id="btnLoading" class="fa-solid fa-circle-notch animate-spin hidden"></i>
            </button>
        </div>
        
        <p class="text-center text-xs text-gray-400 font-bold">Â© TDEA å°ç£æ•¸ä½æ•™è‚²å”æœƒ</p>
    </div>

    <!-- ğŸŸ¢ 3. æˆåŠŸé é¢ / è·³è½‰ä¸­ -->
    <div id="successPage" class="hidden flex flex-col items-center text-center space-y-6 fade-in">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-600">
            <i class="fa-solid fa-check-double text-5xl"></i>
        </div>
        <h2 class="text-3xl font-black text-gray-800">èº«åˆ†é©—è­‰æˆåŠŸ</h2>
        <p class="text-gray-500 font-bold">æ­£åœ¨é€²å…¥æ´»å‹•å°ˆå€...</p>
    </div>

    <script>
        const LIFF_ID = "2005868456-cfANNVou";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxJAx1S0rlrggrfo2Rv9u-l2FuPiWthPfGEsQak7nqSrAXzTX1hJ4yIbb20-VVaW-qn/exec";
        
        let userType = "";
        let lineUserId = "";

        // åˆå§‹åŒ–
        window.onload = async () => {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                lineUserId = profile.userId;
                document.getElementById('userName').textContent = profile.displayName;
                document.getElementById('userPicture').src = profile.pictureUrl;

                // ğŸŒŸ ç¬¬ä¸€æ­¥ï¼šæª¢æŸ¥æ˜¯å¦å·²ç¶“ç¶å®š
                checkIsBound(lineUserId);
            } catch (err) {
                alert("LIFF åˆå§‹åŒ–å¤±æ•—");
            }
        };

        // åˆ‡æ›èº«åˆ†æŒ‰éˆ• UI
        function setType(type) {
            userType = type;
            const btns = {
                'æœ¬æ¥­æœƒå“¡': 'btnAssoc',
                'å» å•†æœƒå“¡': 'btnVendor',
                'éæœƒå“¡': 'btnGuest'
            };
            
            Object.values(btns).forEach(id => {
                document.getElementById(id).className = "py-3 rounded-2xl font-bold border-2 transition-all border-gray-100 bg-gray-50 text-gray-400";
            });
            
            document.getElementById(btns[type]).className = "py-3 rounded-2xl font-black border-2 transition-all border-emerald-500 bg-emerald-50 text-emerald-600 shadow-sm";
            
            // æœƒå“¡ç·¨è™Ÿè¼¸å…¥æ¡†é¡¯ç¤ºé‚è¼¯
            document.getElementById('memberIdArea').style.display = type.includes('æœƒå“¡') ? 'block' : 'none';
        }

        // å‘ GAS æª¢æŸ¥ç¶å®šç‹€æ…‹
        async function checkIsBound(uid) {
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'checkMemberBinding', userId: uid })
                });
                const data = await res.json();
                
                if (data.isBound) {
                    showSuccess();
                } else {
                    document.getElementById('loadingPage').classList.add('hidden');
                    document.getElementById('registerForm').classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // åŸ·è¡Œç¶å®šå‹•ä½œ
        async function handleBind() {
            const phone = document.getElementById('userPhone').value.trim();
            const memberId = document.getElementById('memberId').value.trim();

            if (!userType) return alert("è«‹é¸æ“‡æ‚¨çš„èº«åˆ†");
            if (!phone || phone.length < 10) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼");
            if (userType.includes('æœƒå“¡') && !memberId) return alert("æœƒå“¡è«‹è¼¸å…¥ç·¨è™Ÿä»¥åˆ©ç¶å®š");

            toggleBtn(true);

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'bindMember',
                        userId: lineUserId,
                        type: userType,
                        memberId: memberId,
                        phone: phone,
                        name: document.getElementById('userName').textContent
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showSuccess();
                } else {
                    alert("é©—è­‰å¤±æ•—ï¼š" + data.message);
                    toggleBtn(false);
                }
            } catch (e) {
                alert("ä¼ºæœå™¨é€£ç·šå¤±æ•—");
                toggleBtn(false);
            }
        }

        function showSuccess() {
            document.getElementById('loadingPage').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('successPage').classList.remove('hidden');
            // é€™è£¡ä¹‹å¾Œå¯ä»¥è·³è½‰åˆ°æ‚¨çš„æ´»å‹•æ¸…å–®é é¢
            // setTimeout(() => { window.location.href = "activities.html"; }, 1500);
        }

        function toggleBtn(loading) {
            document.getElementById('btnText').style.display = loading ? 'none' : 'inline';
            document.getElementById('btnLoading').classList.toggle('hidden', !loading);
            document.getElementById('submitBtn').disabled = loading;
        }
    </script>
</body>
</html>
