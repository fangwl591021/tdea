<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDEA ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; overflow-x: hidden; }
        .sidebar-bg { background-color: #2d333b; }
        .active-item { background-color: #243b32; border-left: 4px solid #4ade80; color: #4ade80; }
        .menu-item:hover:not(.active-item) { background-color: #3d444d; }
        table th { text-align: center !important; white-space: nowrap; font-size: 13px; font-weight: 800; color: #6b7280; padding: 15px; border-bottom: 2px solid #edf2f7; background-color: #f9fafb; }
        table td { text-align: center !important; font-size: 14px; padding: 12px 8px; border-bottom: 1px solid #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s forwards; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        .drawer-root { position: fixed; inset: 0; z-index: 9999; pointer-events: none; visibility: hidden; }
        .drawer-root.is-open { pointer-events: auto; visibility: visible; }
        .drawer-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .drawer-root.is-open .drawer-overlay { opacity: 1; }
        .drawer-container { position: absolute; right: 0; top: 0; bottom: 0; width: 550px; max-width: 95vw; background: white; box-shadow: -10px 0 50px rgba(0,0,0,0.2); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .drawer-root.is-open .drawer-container { transform: translateX(0); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .lottery-screen { position: fixed; inset: 0; background: white; z-index: 200; overflow: auto; display: flex; flex-direction: column; align-items: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .aspect-video { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; background: #eee; }
        .aspect-video iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // 1. åˆå§‹åŒ–èˆ‡å·¥å…·
        const { useState, useEffect, useContext, createContext, Fragment, useMemo } = window.React;
        const LIFF_ID = "2005868456-cfANNVou"; 
        const API_URL = "https://tdea.fangwl591021.workers.dev/"; 
        const AuthContext = createContext(null);

        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(`${API_URL}?t=${new Date().getTime()}`, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data }) 
                });
                return await response.json();
            } catch (err) { return { success: false, message: "é€£ç·šå¤±æ•—" }; }
        }

        function IconBase({children}) { return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{display:'inline-block', verticalAlign:'middle'}}>{children}</svg>; }
        function BarChart2() { return <IconBase><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>; }
        function Users() { return <IconBase><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></IconBase>; }
        function ActivityIcon() { return <IconBase><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>; }
        function ChevronDown() { return <IconBase><polyline points="6 9 12 15 18 9"/></IconBase>; }
        function IconPlus() { return <IconBase><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>; }
        function Trash2() { return <IconBase><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>; }

        function AuthProvider({ children }) {
            const [authState, setAuthState] = useState({ status: "LOADING", user: null, role: null });
            useEffect(() => {
                const init = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (!liff.isLoggedIn()) { liff.login(); return; }
                        const p = await liff.getProfile();
                        const res = await callAPI('check', { userId: p.userId });
                        if (res.status === 'admin' || res.status === 'member') {
                            setAuthState({ status: "AUTHORIZED", user: p, role: res.status });
                        } else {
                            window.location.replace("login.html");
                        }
                    } catch (err) { setAuthState({ status: "ERROR" }); }
                };
                init();
            }, []);
            if (authState.status === "LOADING") return <div className="h-screen flex items-center justify-center font-black text-gray-400 italic tracking-widest uppercase">Syncing...</div>;
            return <AuthContext.Provider value={authState}>{children}</AuthContext.Provider>;
        }

        // ğŸŒŸ æœƒå“¡å¤§å»³ (App é¢¨æ ¼æ”¹ç‰ˆ + å–æ¶ˆå ±å)
        function MemberLobby() {
            const { user } = useContext(AuthContext);
            const [view, setView] = useState('lobby'), [activities, setActivities] = useState([]), [history, setHistory] = useState([]), [loading, setLoading] = useState(true), [selectedActivity, setSelectedActivity] = useState(null);

            const fetchData = async () => {
                setLoading(true);
                if (view === 'lobby') { const res = await callAPI('getActivityList'); setActivities((res.data || []).filter(x => x.ç‹€æ…‹ === 'ä¸Šæ¶')); } 
                else { const res = await callAPI('getUserRegistrations', { userId: user.userId }); setHistory(res.data || []); }
                setLoading(false);
            };
            useEffect(() => { fetchData(); }, [view]);

            const handleRegisterConfirm = async (act, meal) => {
                const res = await callAPI('registerForActivity', { userId: user.userId, activityId: act['æ´»å‹•è©¦ç®—è¡¨ID'], meal: meal });
                if (res.success) { alert("ğŸ‰ å ±åæˆåŠŸï¼"); setView('history'); } else { alert("å ±åå¤±æ•—ï¼š" + res.message); }
            };

            const handleCancel = async (reg) => {
                if(!confirm(`ç¢ºå®šå–æ¶ˆã€Œ${reg.name}ã€çš„å ±åå—ï¼Ÿ`)) return;
                setLoading(true);
                const res = await callAPI('cancelRegistration', { userId: user.userId, activityId: reg.id });
                if(res.success) { fetchData(); alert("å·²å–æ¶ˆå ±å"); } else { alert("å–æ¶ˆå¤±æ•—"); setLoading(false); }
            };

            return (
                <div className="bg-gray-50 min-h-screen pb-20">
                    <ActivityDetailModal isOpen={!!selectedActivity} activity={selectedActivity} onClose={()=>setSelectedActivity(null)} onConfirm={handleRegisterConfirm} />
                    
                    {/* APP é ‚éƒ¨ */}
                    <div className="bg-white px-6 py-4 shadow-sm flex items-center justify-between sticky top-0 z-30">
                        <div className="flex items-center gap-3">
                            <img src={user.pictureUrl} className="w-10 h-10 rounded-full border border-gray-200" />
                            <div><p className="text-xs text-gray-400 font-bold">æ­¡è¿å›ä¾†</p><h2 className="text-lg font-black text-gray-800">{user.displayName}</h2></div>
                        </div>
                    </div>

                    {/* åˆ‡æ›æ¨™ç±¤ */}
                    <div className="px-4 py-4">
                        <div className="flex bg-white p-1 rounded-xl shadow-sm border border-gray-100">
                            <button onClick={()=>setView('lobby')} className={`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all ${view==='lobby'?'bg-emerald-500 text-white shadow-md':'text-gray-400'}`}>æ´»å‹•å ±å</button>
                            <button onClick={()=>setView('history')} className={`flex-1 py-2.5 rounded-lg font-bold text-sm transition-all ${view==='history'?'bg-emerald-500 text-white shadow-md':'text-gray-400'}`}>æˆ‘çš„ç´€éŒ„</button>
                        </div>
                    </div>

                    {/* å…§å®¹å€ */}
                    <div className="px-4 space-y-3">
                        {loading ? <div className="p-10 text-center text-gray-400 text-sm animate-pulse">è¼‰å…¥ä¸­...</div> : (
                            view === 'lobby' ? (
                                activities.length === 0 ? <p className="text-center py-10 text-gray-400 text-sm">æš«ç„¡æ´»å‹•</p> : 
                                activities.map((act, i) => (
                                    <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex gap-4 active:scale-[0.98] transition-transform" onClick={()=>setSelectedActivity(act)}>
                                        <div className="w-20 h-20 bg-gray-100 rounded-xl flex-shrink-0 overflow-hidden relative">
                                            {act['åœ–ç‰‡é€£çµ'] ? <img src={act['åœ–ç‰‡é€£çµ']} className="w-full h-full object-cover" onError={(e)=>{e.target.style.display='none'}}/> : <div className="w-full h-full flex items-center justify-center text-xs text-gray-300">ç„¡åœ–</div>}
                                        </div>
                                        <div className="flex-1 flex flex-col justify-between py-0.5">
                                            <div>
                                                <h3 className="font-bold text-gray-800 text-base line-clamp-1">{act['æ´»å‹•åç¨±']}</h3>
                                                <p className="text-xs text-emerald-600 font-bold mt-1">ğŸ“… {act['èª²ç¨‹æ™‚é–“']}</p>
                                            </div>
                                            <div className="flex justify-end"><span className="text-xs bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg font-bold">æŸ¥çœ‹è©³æƒ…</span></div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                history.length === 0 ? <p className="text-center py-10 text-gray-400 text-sm">å°šç„¡ç´€éŒ„</p> : 
                                history.map((reg, i) => (
                                    <div key={i} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-gray-800 text-base">{reg.name}</h3>
                                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${reg.status==='æœªç°½åˆ°'?'bg-blue-50 text-blue-500':'bg-green-50 text-green-600'}`}>{reg.status==='æœªç°½åˆ°'?'å·²å ±å':reg.status}</span>
                                        </div>
                                        <div className="flex justify-between items-end">
                                            <p className="text-xs text-gray-400 font-mono">ğŸ“… {reg.time}</p>
                                            {reg.status === 'æœªç°½åˆ°' && (
                                                <button onClick={(e) => { e.stopPropagation(); handleCancel(reg); }} className="bg-white border border-red-200 text-red-500 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-50 active:scale-95 transition">å–æ¶ˆé ç´„</button>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )
                        )}
                    </div>
                </div>
            );
        }

        // --- å…¶ä»–ç®¡ç†å“¡çµ„ä»¶ (CreateActivityModal, DetailPage, EditDrawer ç­‰è«‹ä½¿ç”¨ v18.0 ä»£ç¢¼ï¼Œæ­¤è™•çœç•¥ä»¥ç¯€çœç¯‡å¹…) ---
        // è«‹å‹™å¿…å°‡ä¸Šæ–¹æä¾›çš„å®Œæ•´çµ„ä»¶ä»£ç¢¼è²¼å›æ­¤è™•ï¼Œå°¤å…¶æ˜¯ ActivityDetailModal å¿…é ˆå­˜åœ¨
        
        function ActivityDetailModal({ isOpen, onClose, activity, onConfirm }) {
            const [meal, setMeal] = useState("è‘·é£Ÿ"); const [processing, setProcessing] = useState(false); if (!isOpen || !activity) return null;
            const getEmbedUrl = (url) => { if(!url) return null; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}` : null; };
            const embedUrl = getEmbedUrl(activity['å½±ç‰‡é€£çµ']);
            const handleRegister = async () => { setProcessing(true); const mealChoice = activity.è‘·ç´  === "Y" ? meal : "ç„¡éœ€æ±‚"; await onConfirm(activity, mealChoice); setProcessing(false); onClose(); };
            return (<div className="modal-overlay"><div className="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl p-0 overflow-hidden mx-4 max-h-[90vh] flex flex-col animate-in fade-in zoom-in duration-300 relative"><button onClick={onClose} className="absolute top-4 right-4 bg-white/80 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold shadow z-20">&times;</button><div className="overflow-y-auto pb-8"><div className="p-6 pb-2 text-center"><h3 className="text-xl font-black text-gray-800 mb-1">{activity['æ´»å‹•åç¨±']}</h3><span className="bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded text-[10px] font-bold tracking-widest">{activity['æ´»å‹•é¡å‹']}</span></div>{activity['åœ–ç‰‡é€£çµ']&&(<div className="w-full h-48 bg-gray-100"><img src={activity['åœ–ç‰‡é€£çµ']} className="w-full h-full object-cover" onError={(e)=>{e.target.style.display='none'}}/></div>)}<div className="p-6 space-y-4">{embedUrl&&(<div className="aspect-video rounded-xl overflow-hidden shadow border border-gray-100"><iframe src={embedUrl} frameBorder="0" allowFullScreen></iframe></div>)}<div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-sm text-gray-600 whitespace-pre-wrap">{activity['æ´»å‹•å…§å®¹']||"æš«ç„¡èªªæ˜"}</div><div className="grid grid-cols-2 gap-2 text-center bg-blue-50 p-3 rounded-xl"><div><p className="text-[10px] text-blue-400 font-bold">æ™‚é–“</p><p className="font-bold text-sm text-blue-900">{activity['èª²ç¨‹æ™‚é–“']}</p></div><div><p className="text-[10px] text-blue-400 font-bold">æˆªæ­¢</p><p className="font-bold text-sm text-red-500">{activity['æˆªæ­¢æ—¥æœŸ']}</p></div></div>{activity.è‘·ç´ ==="Y"&&(<div><label className="text-xs font-bold text-gray-400 block mb-2 text-center">é¤é»é¸æ“‡</label><div className="flex gap-2">{['è‘·é£Ÿ','ç´ é£Ÿ','ä¸éœ€ç”¨é¤'].map(opt=>(<button key={opt} onClick={()=>setMeal(opt)} className={`flex-1 py-2 rounded-lg font-bold text-xs border ${meal===opt?'border-emerald-500 bg-emerald-50 text-emerald-700':'border-gray-200 text-gray-400'}`}>{opt}</button>))}</div></div>)}<button onClick={handleRegister} disabled={processing} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">{processing?"è™•ç†ä¸­...":"ç¢ºèªå ±å"}</button></div></div></div></div>);
        }

        // å ä½ç¬¦ï¼šè«‹å°‡ v16.4 çš„ç®¡ç†å“¡çµ„ä»¶ (CreateActivityModal, DetailPage, EditDrawer, LotteryDrawer, ReclassifyModal, MemberTable, DashboardView, ActivityConsole) å®Œæ•´è²¼åœ¨é€™è£¡
        // ... (ç‚ºäº†ç¯‡å¹…ï¼Œæ­¤è™•çœç•¥ï¼Œè«‹å‹™å¿…è£œä¸Š) ...
        function CreateActivityModal({ isOpen, onClose, onSaved }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function DetailPage({ activity, onBack, onRefresh }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function EditDrawer({ isOpen, onClose, item, sheetName, onSaved, cols }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function ReclassifyModal({ isOpen, activity, onClose, onRefresh }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function LotteryDrawer({ isOpen, activity, onClose, onDataChange }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function DashboardView({ activityData }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function ActivityConsole({ activityData, fetchActivities, setSelectedDetail, setCreateOpen, setReTarget, setLotTarget, handleTakeDown }) { /* v18.0 ä»£ç¢¼ */ return null; }
        function MemberTable({ title, sheetName }) { /* v18.0 ä»£ç¢¼ */ return null; }

        function MainApp() {
            const { role } = useContext(AuthContext);
            const [view, setView] = useState('dashboard'), [activityData, setActivityData] = useState([]), [expandedMenu, setExpandedMenu] = useState(false), [selectedDetail, setSelectedDetail] = useState(null), [isCreateOpen, setCreateOpen] = useState(false);
            const [lotTarget, setLotTarget] = useState(null), [reTarget, setReTarget] = useState(null);
            
            const fetchActivities = () => { callAPI('getActivityList').then(res => setActivityData(res.data || [])); };
            useEffect(() => { if(role==='admin') fetchActivities(); }, [role]);
            const handleTakeDown = async (actName) => { const act = activityData.find(x => x['æ´»å‹•åç¨±'] === actName); if (!act) return; const nextState = act.ç‹€æ…‹ === 'ä¸Šæ¶' ? 'ä¸‹æ¶' : 'ä¸Šæ¶'; if(confirm(`ç¢ºå®šè¦${nextState}ã€Œ${actName}ã€å—ï¼Ÿ`)){ await callAPI('updateActivityStatus',{name:actName,status:nextState}); fetchActivities(); } };

            if (role === "member") return <MemberLobby />;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* è«‹ç¢ºä¿é€™è£¡æœ‰å®Œæ•´çš„ Modal çµ„ä»¶å®£å‘Š */}
                    <CreateActivityModal isOpen={isCreateOpen} onClose={()=>setCreateOpen(false)} onSaved={fetchActivities} />
                    <LotteryDrawer isOpen={!!lotTarget} activity={lotTarget} onClose={()=>setLotTarget(null)} onDataChange={fetchActivities} />
                    <ReclassifyModal isOpen={!!reTarget} activity={reTarget} onClose={()=>setReTarget(null)} onRefresh={fetchActivities} />
                    
                    <div className="w-80 sidebar-bg text-gray-300 flex flex-col shrink-0 shadow-2xl">
                        <div className="p-12 border-b border-gray-700 text-[#4ade80] text-4xl font-black text-center italic tracking-tighter uppercase leading-none">TDEA<br/><span className="text-[10px] tracking-widest font-bold opacity-30 not-italic">ADMIN</span></div>
                        <nav className="flex-1 mt-10 space-y-2">
                            <div className={`px-10 py-6 cursor-pointer flex items-center gap-5 transition-all ${view==='dashboard'?'active-item':'menu-item'}`} onClick={()=>{setView('dashboard');setSelectedDetail(null);}}><BarChart2/><span>ç³»çµ±ç¸½è¦½</span></div>
                            <div className={`px-10 py-6 cursor-pointer flex items-center gap-5 transition-all ${view==='activity'?'active-item':'menu-item'}`} onClick={()=>{setView('activity');setSelectedDetail(null);}}><ActivityIcon/><span>æ´»å‹•æ§åˆ¶ä¸­å¿ƒ</span></div>
                            <div className={`px-10 py-6 cursor-pointer flex items-center justify-between menu-item transition-all ${['assoc','vendor','guest'].includes(view)?'text-green-400':''}`} onClick={() => setExpandedMenu(!expandedMenu)}>
                                <div className="flex items-center gap-5"><Users/><span>æœƒå“¡åå†Šç®¡ç†</span></div><div className={`transition-transform duration-300 ${expandedMenu?'rotate-180':''}`}><ChevronDown/></div>
                            </div>
                            {expandedMenu && (<div className="bg-[#24292f] border-l-8 border-[#243b32] transition-all duration-300 overflow-hidden"><div onClick={()=>{setView('assoc');setSelectedDetail(null);}} className={`px-16 py-4 cursor-pointer text-sm font-bold ${view==='assoc'?'text-green-400 bg-[#243b32]' : 'text-gray-500 hover:text-white'}`}>å”æœƒæœƒå“¡åå†Š</div><div onClick={()=>{setView('vendor');setSelectedDetail(null);}} className={`px-16 py-4 cursor-pointer text-sm font-bold ${view==='vendor'?'text-green-400 bg-[#243b32]' : 'text-gray-500 hover:text-white'}`}>å» å•†è´ŠåŠ©åå†Š</div><div onClick={()=>{setView('guest');setSelectedDetail(null);}} className={`px-16 py-4 cursor-pointer text-sm font-bold ${view==='guest'?'text-green-400 bg-[#243b32]' : 'text-gray-500 hover:text-white'}`}>ä¸€èˆ¬è¨»å†Šåå†Š</div></div>)}
                        </nav>
                    </div>
                    <main className="flex-1 overflow-auto bg-[#f8fafc] no-scrollbar">
                        {selectedDetail ? <DetailPage activity={selectedDetail} onBack={()=>setSelectedDetail(null)} onRefresh={fetchActivities} /> : (
                            <Fragment>
                                {view==='dashboard' && <DashboardView activityData={activityData} />}
                                {view==='activity' && <ActivityConsole activityData={activityData} fetchActivities={fetchActivities} setSelectedDetail={setSelectedDetail} setCreateOpen={setCreateOpen} setReTarget={setReTarget} setLotTarget={setLotTarget} handleTakeDown={handleTakeDown} />}
                                {view==='assoc' && <MemberTable title="å”æœƒæ­£å¼æœƒå“¡åå†Šç®¡ç†" sheetName="æœ¬æ¥­æœƒå“¡" />}
                                {view==='vendor' && <MemberTable title="å» å•†è´ŠåŠ©å–®ä½åå†Šç®¡ç†" sheetName="å» å•†æœƒå“¡" />}
                                {view==='guest' && <MemberTable title="ä¸€èˆ¬è¨»å†Šåå†Šè³‡æ–™ç®¡ç†" sheetName="ä¸€èˆ¬æœƒå“¡" />}
                            </Fragment>
                        )}
                    </main>
                </div>
            );
        }

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
