<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TDEA æ´»å‹•ç®¡ç†ç³»çµ± - æ¬Šé™é©—è­‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥ FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .fade-in { animation: fadeIn .4s ease-in-out forwards; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
    .hidden { display: none !important; }
    .btn-line { background: linear-gradient(to right, #06c755, #05b34c); }
    .btn-line:active { background: #049f43; transform: scale(0.98); }
    .input-field:focus { border-color: #06c755; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.2); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans text-gray-700">

  <!-- ğŸŸ¢ Loading / Splash ç•«é¢ -->
  <div id="splash" class="flex flex-col items-center justify-center w-full max-w-sm mx-auto text-center space-y-6 fade-in">
    <div class="relative w-24 h-24 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-4">
      <i class="fa-solid fa-shield-halved text-4xl text-green-500"></i>
    </div>
    <div class="space-y-2">
      <h2 class="text-xl font-bold text-gray-800">TDEA æ´»å‹•ç®¡ç†ç³»çµ±</h2>
      <div class="flex items-center justify-center space-x-2 text-green-600 text-sm font-medium">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>é©—è­‰æ¬Šé™ä¸­...</span>
      </div>
    </div>
    <div id="debugInfo" class="text-xs text-gray-400 font-mono mt-8 px-4 break-all"></div>
  </div>

  <!-- â³ å¯©æ ¸ä¸­ç•«é¢ (æ–°å¢) -->
  <div id="pendingPage" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center hidden fade-in">
    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fa-solid fa-hourglass-half text-3xl text-yellow-600"></i>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">æ¬Šé™å¯©æ ¸ä¸­</h2>
    <p class="text-gray-600 mb-6">æ‚¨çš„ç”³è«‹å·²é€å‡ºï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡é–‹é€šå¾Œå°æ¬Šé™ã€‚</p>
    <div class="bg-gray-50 rounded-lg p-4 text-left text-sm text-gray-500 mb-6">
      <p><strong>ç”³è«‹äººï¼š</strong> <span id="pendingName">-</span></p>
      <p><strong>ç‹€æ…‹ï¼š</strong> <span class="text-yellow-600 font-bold">å¾…å¯©æ ¸</span></p>
    </div>
    <button onclick="window.location.reload()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">
      é‡æ–°æ•´ç†ç‹€æ…‹
    </button>
  </div>

  <!-- â›” ç„¡æ¬Šé™ç•«é¢ (æ–°å¢) -->
  <div id="accessDeniedPage" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center hidden fade-in">
    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fa-solid fa-ban text-3xl text-red-600"></i>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">ç„¡å­˜å–æ¬Šé™</h2>
    <p class="text-gray-600 mb-6">æ‚¨çš„å¸³è™Ÿå·²è¢«åœç”¨æˆ–æ¬Šé™ä¸è¶³ã€‚</p>
    <button onclick="window.close()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all">
      é—œé–‰é é¢
    </button>
  </div>

  <!-- ğŸ“ è¨»å†Šè¡¨å–® (æœªè¨»å†Šæ‰é¡¯ç¤º) -->
  <div id="registerForm" class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden hidden fade-in">
    <div class="bg-green-500 p-6 text-center text-white relative">
        <h1 class="text-xl font-bold tracking-wide">å¾Œå°æ¬Šé™ç”³è«‹</h1>
        <p class="text-green-100 text-sm mt-1">è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥ä¾›å¯©æ ¸</p>
        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2">
            <div class="w-16 h-16 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-md">
                <img id="userAvatar" src="https://via.placeholder.com/150" alt="Avatar" class="w-full h-full object-cover">
            </div>
        </div>
    </div>

    <div class="pt-12 pb-8 px-6 space-y-4">
      <div class="text-center mb-4">
        <p id="displayName" class="font-bold text-gray-800 text-lg">è¼‰å…¥ä¸­...</p>
        <div class="mt-2 p-2 bg-blue-50 text-blue-700 text-xs rounded-lg border border-blue-100">
          <i class="fa-solid fa-circle-info mr-1"></i> æäº¤å¾Œéœ€äººå·¥æ ¸å‡†æ‰èƒ½ç™»å…¥
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">çœŸå¯¦å§“å</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-regular fa-user text-gray-400"></i>
            </div>
            <input id="name" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" 
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-phone text-gray-400"></i>
            </div>
            <input id="phone" type="tel" placeholder="0912345678" maxlength="10"
                class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all text-gray-700 placeholder-gray-400">
        </div>
      </div>

      <div class="pt-4">
        <button id="registerBtn" onclick="registerUser()" class="btn-line w-full text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-green-200 transition-all flex items-center justify-center space-x-2">
            <span id="btnText">æäº¤ç”³è«‹</span>
            <div id="btnSpinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
        </button>
      </div>
    </div>
  </div>

<script>
/* ==========================================
   âš™ï¸ ç³»çµ±è¨­å®š
   ========================================== */
const LIFF_ID        = '2005868456-cfANNVou';     
const WORKER_URL     = 'https://delicate-math-7e61.fangwl591021.workers.dev/'; 
const NEXT_PAGE      = 'main.html';
const SPREADSHEET_ID = '1qJ900hzX1nuN4D2wprXtoknfWOfU8wFrRd4-T3eiGkA';

/* ==========================================
   ğŸ› ï¸ å·¥å…·
   ========================================== */
const $ = id => document.getElementById(id);
const mask = u => u ? (u.slice(0,8)+'****') : '';
function updateDebug(msg){ console.log('ğŸ”', msg); } // é–‹ç™¼æ™‚å¯è§£é™¤è¨»è§£è®“æ‰‹æ©Ÿé¡¯ç¤º: $('debugInfo').innerHTML += `<div>${msg}</div>`;

function showPage(pageId) {
    ['splash', 'registerForm', 'pendingPage', 'accessDeniedPage'].forEach(id => {
        $(id).classList.add('hidden');
    });
    $(pageId).classList.remove('hidden');
}

function setBtnLoading(isLoading) {
    const btn = $('registerBtn');
    btn.disabled = isLoading;
    if (isLoading) {
        $('btnText').classList.add('hidden');
        $('btnSpinner').classList.remove('hidden');
        btn.classList.add('opacity-70', 'cursor-not-allowed');
    } else {
        $('btnText').classList.remove('hidden');
        $('btnSpinner').classList.add('hidden');
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
    }
}

let currentUserId = null;
let userProfile = null;

/* ==========================================
   ğŸš€ åˆå§‹åŒ–æµç¨‹ (åš´æ ¼æ¬Šé™æª¢æŸ¥)
   ========================================== */
(async function initApp() {
    try {
        updateDebug('å•Ÿå‹• LIFF åˆå§‹åŒ–...');
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: location.href });
            return;
        }

        userProfile = await liff.getProfile();
        currentUserId = userProfile.userId;
        updateDebug('User: ' + userProfile.displayName);
        
        // é å¡«è¡¨å–®è³‡è¨Š
        $('displayName').textContent = userProfile.displayName;
        if (userProfile.pictureUrl) $('userAvatar').src = userProfile.pictureUrl;
        $('name').value = userProfile.displayName;

        // ğŸŸ¢ æª¢æŸ¥è¨»å†Šç‹€æ…‹èˆ‡æ¬Šé™
        await checkPermission(currentUserId);

    } catch (err) {
        console.error('Error:', err);
        alert('ç³»çµ±éŒ¯èª¤ï¼š' + err.message);
    }
})();

// ğŸ“¡ æª¢æŸ¥æ¬Šé™æ ¸å¿ƒé‚è¼¯
async function checkPermission(userId) {
    updateDebug('æª¢æŸ¥æ¬Šé™ä¸­...');
    
    try {
        const checkUrl = `${WORKER_URL}?mode=check&userId=${encodeURIComponent(userId)}&spreadsheetId=${encodeURIComponent(SPREADSHEET_ID)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();
        
        updateDebug('API å›æ‡‰: ' + JSON.stringify(result));

        // 1. åˆ¤æ–·æ˜¯å¦è¨»å†Š
        const isRegistered = (result.data && result.data.registered === true) || (result.registered === true);
        
        // 2. å–å¾—æ¬Šé™æ¬„ä½ (å‡è¨­å¾Œç«¯å›å‚³çš„ç‰©ä»¶ä¸­æœ‰ role æˆ– data.role æˆ– data['æ¬Šé™'])
        let role = '';
        const userData = result.data || result.user || {};
        
        if (userData.role) role = userData.role;
        else if (userData['æ¬Šé™']) role = userData['æ¬Šé™']; // å…¼å®¹ä¸­æ–‡æ¬„ä½
        
        updateDebug(`ç‹€æ…‹: ${isRegistered ? 'å·²è¨»å†Š' : 'æœªè¨»å†Š'}, æ¬Šé™: ${role}`);

        if (isRegistered) {
            // âœ… å·²è¨»å†Šï¼Œé€²è¡Œæ¬Šé™åˆ†æµ
            if (role === 'ç®¡ç†å“¡' || role === 'Admin') {
                updateDebug('âœ… æ¬Šé™é€šéï¼Œé€²å…¥å¾Œå°');
                setTimeout(() => window.location.replace(NEXT_PAGE), 800);
            } 
            else if (role === 'å¾…å¯©æ ¸' || role === 'pending') {
                updateDebug('â³ å¾…å¯©æ ¸');
                $('pendingName').textContent = userData.name || userData.displayName || userProfile.displayName;
                showPage('pendingPage');
            } 
            else {
                updateDebug('â›” ç„¡æ¬Šé™');
                showPage('accessDeniedPage');
            }
        } else {
            // ğŸ“ æœªè¨»å†Š -> é¡¯ç¤ºè¡¨å–®
            updateDebug('æœªè¨»å†Šï¼Œé¡¯ç¤ºè¡¨å–®');
            showPage('registerForm');
        }

    } catch (err) {
        updateDebug('API Error: ' + err.message);
        // è‹¥ API éŒ¯èª¤ï¼Œä¿å®ˆèµ·è¦‹é¡¯ç¤ºè¡¨å–®æˆ–éŒ¯èª¤é ï¼Œé€™è£¡é¸æ“‡é¡¯ç¤ºè¡¨å–®è®“ç”¨æˆ¶é‡è©¦
        showPage('registerForm');
    }
}

/* ==========================================
   ğŸ“ è¨»å†Š (é€å‡ºå¾Œè®Šç‚ºå¾…å¯©æ ¸)
   ========================================== */
async function registerUser() {
    const name = $('name').value.trim();
    const phone = $('phone').value.trim();

    if (!name || !phone) { alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™'); return; }
    if (!/^09\d{8}$/.test(phone)) { alert('è«‹è¼¸å…¥æ­£ç¢ºæ‰‹æ©Ÿè™Ÿç¢¼'); return; }

    const payload = {
        type: 'register',
        mode: 'register',
        action: 'register',
        spreadsheetId: SPREADSHEET_ID,
        userId: currentUserId,
        name: name,
        displayName: name,
        phone: phone,
        
        // ğŸŸ¢ å¯«å…¥æ¬Šé™ç‚º "å¾…å¯©æ ¸"
        role: 'å¾…å¯©æ ¸',
        "å§“å": name,
        "é›»è©±": phone,
        "æ¬Šé™": "å¾…å¯©æ ¸",
        "Line UserID": currentUserId,
        
        // å…¼å®¹èˆŠç³»çµ±çš„å¡«å……æ¬„ä½
        studentId: '-',
        department: '-',
        
        pictureUrl: userProfile?.pictureUrl || '',
        timestamp: new Date().toISOString()
    };

    setBtnLoading(true);

    try {
        // åŒæ™‚åœ¨ URL å’Œ Body å‚³é€ IDï¼Œç¢ºä¿å¯«å…¥æ­£ç¢ºå·¥ä½œè¡¨
        const postUrl = `${WORKER_URL}?spreadsheetId=${encodeURIComponent(SPREADSHEET_ID)}`;
        
        const response = await fetch(postUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (result.ok || result.status === 'success' || result.success) {
            alert('âœ… ç”³è«‹æˆåŠŸï¼\nè«‹é€šçŸ¥ç®¡ç†å“¡é€²è¡Œå¯©æ ¸ã€‚');
            // è¨»å†ŠæˆåŠŸå¾Œï¼Œç›´æ¥åˆ‡æ›åˆ°å¯©æ ¸ä¸­é é¢ï¼Œä¸è¦è·³è½‰ main.html
            $('pendingName').textContent = name;
            showPage('pendingPage');
        } else {
            throw new Error(result.message || result.error || 'ç„¡æ³•å¯«å…¥è³‡æ–™åº«');
        }

    } catch (err) {
        alert('è¨»å†Šå¤±æ•—ï¼š' + err.message);
    } finally {
        setBtnLoading(false);
    }
}
</script>
</body>
</html>
